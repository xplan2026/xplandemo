# Tactics-1 Worker 部署指南

**更新日期**: 2026-02-08  
**Worker 名称**: tactics-1  
**版本**: v1.0.0

---

## 前置条件

1. 已安装 Node.js 和 npm
2. 已安装 Wrangler CLI: `npm install -g wrangler`
3. 已登录 Cloudflare（或使用 API Token）
4. 已配置 `.env` 文件（包含所有必需的密钥）

---

## 一键部署（推荐）

### Windows PowerShell

```powershell
cd d:\TOBEHOST\xplan2026\cloudflare\tactics-1
PowerShell -ExecutionPolicy Bypass -File quick-deploy.ps1
```

此脚本将自动：
1. 从 `.env` 文件读取配置
2. 配置所有 Worker Secrets
3. 验证 Secrets 配置
4. 部署 Worker

---

## 分步部署

### 步骤 1: 配置 .env 文件

确保项目根目录有 `.env` 文件，包含以下配置：

```bash
# API 密钥
API_SECRET_KEY=<your-api-key>

# Supabase 配置
SUPABASE_URL=https://jkugpzhhetpiplnzbguw.supabase.co
SUPABASE_ANON_KEY=<your-supabase-anon-key>

# 钱包私钥
PROTECTED_PRIVATE_KEY=<your-protected-wallet-private-key>
SAFE_PRIVATE_KEY=<your-safe-wallet-private-key>
GAS_PRIVATE_KEY=<your-gas-wallet-private-key>

# Cloudflare 配置
CLOUDFLARE_API_TOKEN=<your-cloudflare-api-token>
CLOUDFLARE_ACCOUNT_ID=1b9f2ccbdc655cf10384c9ef205b6eab
```

### 步骤 2: 配置 Secrets

#### Windows PowerShell

```powershell
cd d:\TOBEHOST\xplan2026\cloudflare\tactics-1
PowerShell -ExecutionPolicy Bypass -File setup-secrets.ps1
```

#### Linux/Mac Bash

```bash
cd /path/to/xplan2026/cloudflare/tactics-1
chmod +x setup-secrets.sh
./setup-secrets.sh
```

### 步骤 3: 验证 Secrets

```bash
npx wrangler secret list
```

应该看到以下 Secrets：
- `API_KEY`
- `SUPABASE_URL`
- `SUPABASE_KEY`
- `WALLET_PRIVATE_KEY_32af...`
- `SAFE_WALLET_PRIVATE_KEY`
- `GAS_FUNDING_WALLET_PRIVATE_KEY`

### 步骤 4: 部署 Worker

#### 设置环境变量

**Windows PowerShell**:
```powershell
$env:CLOUDFLARE_API_TOKEN = "<your-cloudflare-api-token>"
$env:CLOUDFLARE_ACCOUNT_ID = "1b9f2ccbdc655cf10384c9ef205b6eab"
```

**Linux/Mac**:
```bash
export CLOUDFLARE_API_TOKEN="<your-cloudflare-api-token>"
export CLOUDFLARE_ACCOUNT_ID="1b9f2ccbdc655cf10384c9ef205b6eab"
```

#### 执行部署

```bash
npx wrangler deploy
```

成功部署后应看到：
```
✅ Successfully published your Worker to
  tactics-1.xplan2026.workers.dev
```

---

## API 密钥信息

### 全局 API Key

从 `.env` 文件配置 `API_SECRET_KEY`，例如：

```
<your-api-key>
```

**用途**: Worker 端点认证

### Cloudflare API Token

从 Cloudflare Dashboard 获取 API Token，在 `.env` 文件配置 `CLOUDFLARE_API_TOKEN`。

**用途**: Worker 部署和管理

### Account ID

```
1b9f2ccbdc655cf10384c9ef205b6eab
```

---

## Worker URL

**生产 URL**:
```
https://tactics-1.xplan2026.workers.dev
```

**测试端点**:

| 端点 | 方法 | 说明 |
|------|------|------|
| `/health` | GET | 健康检查 |
| `/status` | GET | 查询所有钱包状态 |
| `/wallet?address=...` | GET | 单个钱包详情 |
| `/emergency` | GET | 应急状态查询 |
| `/scan` | POST | 手动触发扫描（需 API Key） |
| `/test/transfer` | POST | 测试转账（需 API Key） |
| `/emergency/enable` | POST | 启用应急模式（需 API Key） |
| `/emergency/disable` | POST | 禁用应急模式（需 API Key） |
| `/restart` | POST | 重启 Worker（需 API Key） |
| `/api-docs` | GET | API 文档 |

---

## 测试部署

### 1. 健康检查

```bash
curl https://tactics-1.xplan2026.workers.dev/health
```

预期返回：
```json
{
  "status": "healthy",
  "worker_id": "tactics-1",
  "worker_name": "tactics-1",
  "timestamp": "2026-02-08T..."
}
```

### 2. 查询状态

```bash
curl https://tactics-1.xplan2026.workers.dev/status
```

### 3. 测试转账（需要 API Key）

```bash
curl -X POST https://tactics-1.xplan2026.workers.dev/test/transfer \
  -H "Content-Type: application/json" \
  -H "X-API-Key: <your-api-key>" \
  -d '{"amount": 1}'
```

---

## 前端集成

### 前端默认 API 配置

在 `frontend/DemoSite/js/api.js` 中：

```javascript
const API_CONFIG = {
  main: 'https://tactics-1.xplan2026.workers.dev',
  backup: 'https://tactics-1.xplan2026.workers.dev'
}

// API Key 通过前端界面输入
const API_KEY = ''  // 用户手动输入
```

### 前端访问

在浏览器中打开：
```
file:///d:/TOBEHOST/xplan2026/frontend/DemoSite/index.html
```

或使用 Live Server:
```bash
cd d:\TOBEHOST\xplan2026\frontend\DemoSite
python -m http.server 3000
```

然后访问: `http://localhost:3000`

---

## 配置文件说明

### wrangler.toml

Worker 主配置文件，包含：
- Worker 名称和入口文件
- Cron Trigger 配置
- KV 命名空间绑定
- 环境变量
- 可观测性配置

### .env

全局环境变量文件（本地使用），包含：
- 区块链网络配置
- 钱包地址和私钥
- Worker 配置
- API 密钥
- Supabase 配置

**注意**: `.env` 文件不应提交到 Git 仓库

---

## 故障排查

### 错误 1: Authentication failed

**原因**: API Token 无效或未设置

**解决方法**:
```powershell
$env:CLOUDFLARE_API_TOKEN = "<your-cloudflare-api-token>"
$env:CLOUDFLARE_ACCOUNT_ID = "1b9f2ccbdc655cf10384c9ef205b6eab"
```

### 错误 2: Account not found

**原因**: Account ID 不正确

**解决方法**: 检查 `wrangler.toml` 中的 `account_id`

### 错误 3: Secret not found

**原因**: Worker Secret 未配置

**解决方法**:
```bash
npx wrangler secret list
```

如果没有输出，运行 `setup-secrets.ps1` 重新配置

### 错误 4: API Key not found

**原因**: Worker 中未配置 `API_KEY` Secret

**解决方法**:
```bash
echo "<your-api-key>" | npx wrangler secret put API_KEY
```

---

## 更新 Secrets

如需更新某个 Secret，使用以下命令：

```bash
# 更新 API Key
npx wrangler secret put API_KEY
# 输入新的密钥

# 更新钱包私钥
npx wrangler secret put WALLET_PRIVATE_KEY_32af...
# 输入新的私钥
```

---

## 查看日志

### 查看实时日志

```bash
npx wrangler tail
```

### 查看日志摘要

访问 Cloudflare Dashboard:
1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 选择账户
3. 进入 Workers & Pages
4. 点击 tactics-1 Worker
5. 查看 Logs 标签

---

## 相关文档

- [API配置](/workspace/docs/API配置.md)
- [适配说明](/workspace/cloudflare/tactics-1/适配说明.md)
- [前端功能说明](/workspace/docs/前端功能说明.md)
- [项目背景](/workspace/docs/项目背景.md)

---

**最后更新**: 2026-02-08
