# tactics-1 Worker 适配说明

**日期**: 2026-02-07
**版本**: v1.0.0
**网络**: Polygon Amoy Testnet (Chain ID: 80002)

---

## 修改概述

将 `worker-integrated-pool` Worker 适配到 X-plan Demo 项目，主要修改包括：

1. **网络迁移**: 从 BSC 迁移到 Polygon Amoy
2. **代币更换**: wkeyDAO/USDT → XPD (精度: 9)
3. **Gas代币**: BNB → POL
4. **API端点优化**: 添加测试转账端点，清理不需要的端点
5. **配置更新**: 更新钱包地址和阈值配置

---

## 主要修改内容

### 1. 文件头部注释更新

```javascript
// X-plan Demo - Tactics-1 Worker
// 版本：v1.0.0
// 网络：Polygon Amoy Testnet (Chain ID: 80002)
// 代币：XPD (精度: 9)
```

### 2. 配置常量修改

| 原配置 | 新配置 | 说明 |
|--------|--------|------|
| `WORKER_ID = 'worker-integrated-pool'` | `WORKER_ID = 'tactics-1'` | Worker标识符 |
| `BNB_THRESHOLD = '0.0005'` | `POL_THRESHOLD = '0.01'` | 触发应急状态的阈值 |
| `TOKEN_WKEYDAO` | `TOKEN_XPD` | XPD代币地址 |
| `TOKEN_USDT` | (已删除) | 不再使用USDT |
| `TARGET_BNB_BALANCE` | `TARGET_POL_BALANCE` | 目标余额 |

### 3. 扫描器参数更新

```javascript
// 旧代码
const scanner = createTacticsScanner(env, walletAddress, {
  bnbThreshold: parseFloat(CONFIG.BNB_THRESHOLD),
  tokenWkeyDao: CONFIG.TOKEN_WKEYDAO,
  tokenUsdt: CONFIG.TOKEN_USDT,
  maxDuration: CONFIG.MAX_SCAN_DURATION
})

// 新代码
const scanner = createTacticsScanner(env, walletAddress, {
  polThreshold: parseFloat(CONFIG.POL_THRESHOLD),
  tokenXpd: CONFIG.TOKEN_XPD,
  maxDuration: CONFIG.MAX_SCAN_DURATION
})
```

### 4. 返回数据字段更新

| 旧字段 | 新字段 | 说明 |
|--------|--------|------|
| `bnb_balance` | `pol_balance` | POL余额 |
| `wkeydao_balance` | `xpd_balance` | XPD余额 |
| `usdt_balance` | (已删除) | 不再返回 |

### 5. 转账扩展参数更新

```javascript
// 旧代码
const transferWorker = createTransferWorkerExtension(env, {
  maxRetries: CONFIG.MAX_TRANSFER_RETRIES,
  maxGasErrors: CONFIG.MAX_GAS_ERRORS,
  safeWallet: CONFIG.SAFE_WALLET,
  tokenWkeyDao: CONFIG.TOKEN_WKEYDAO,
  tokenUsdt: CONFIG.TOKEN_USDT,
  gasFundingWallet: CONFIG.GAS_FUNDING_WALLET,
  competitiveMode: CONFIG.COMPETITIVE_MODE
})

// 新代码
const transferWorker = createTransferWorkerExtension(env, {
  maxRetries: CONFIG.MAX_TRANSFER_RETRIES,
  maxGasErrors: CONFIG.MAX_GAS_ERRORS,
  safeWallet: CONFIG.SAFE_WALLET,
  tokenXpd: CONFIG.TOKEN_XPD,
  gasFundingWallet: CONFIG.GAS_FUNDING_WALLET,
  competitiveMode: CONFIG.COMPETITIVE_MODE
})
```

---

## 新增API端点

### 1. 测试转账端点

**端点**: `POST /test/transfer`

**功能**: 从安全钱包转账XPD到被保护钱包（用于演示测试）

**请求头**:
```
Content-Type: application/json
X-API-Key: <your-api-key>
```

**请求体**:
```json
{
  "amount": 10
}
```

**响应**:
```json
{
  "success": true,
  "message": "Test transfer completed",
  "tx_hash": "0x...",
  "from": "0x...",
  "to": "0x...",
  "amount": 10,
  "token": "XPD",
  "block_number": 12345
}
```

### 2. 应急模式控制端点

#### 启用应急模式

**端点**: `POST /emergency/enable`

**功能**: 启用应急模式（扫描间隔5秒）

**请求头**:
```
Content-Type: application/json
X-API-Key: <your-api-key>
```

**请求体**:
```json
{}
```

**响应**:
```json
{
  "success": true,
  "message": "Emergency mode enabled successfully",
  "worker_id": "tactics-1",
  "worker_name": "tactics-1",
  "emergency_mode": true,
  "timestamp": "2026-02-07T12:00:00.000Z"
}
```

#### 禁用应急模式

**端点**: `POST /emergency/disable`

**功能**: 禁用应急模式（恢复正常扫描60秒间隔）

**请求头**:
```
Content-Type: application/json
X-API-Key: <your-api-key>
```

**请求体**:
```json
{}
```

**响应**:
```json
{
  "success": true,
  "message": "Emergency mode disabled successfully",
  "worker_id": "tactics-1",
  "worker_name": "tactics-1",
  "emergency_mode": false,
  "timestamp": "2026-02-07T12:00:00.000Z"
}
```

---

## 保留的API端点

### 1. 健康检查

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/`, `/health` | Worker健康状态 |

### 2. 状态查询

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/status` | 查询所有被保护钱包状态 |
| GET | `/wallet?address=0x...` | 查询单个钱包详情 |
| GET | `/emergency` | 查询应急状态 |

### 3. 手动操作

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | `/scan`, `/trigger` | 手动触发完整扫描 | ✅ 需要 |
| POST | `/restart` | 重启Worker | ✅ 需要 |

### 4. 文档

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api-docs`, `/docs` | 获取API文档 |

---

## wrangler.toml 配置更新

### 主要变更

```toml
# Worker名称
name = "tactics-1"  # 原: worker-integrated-pool

# Account ID
account_id = "1b9f2ccbdc655cf10384c9ef205b6eab"  # 原: 7d8c0fb0cc70cda866c1f942a543417c

# 被保护钱包（单钱包）
PROTECTED_WALLETS = "0x32af405726ba6bd2f9b7ecdfed3bdd9b590c0939"

# RPC节点（Polygon Amoy）
POLYGON_AMOY_RPC = "https://rpc-amoy.polygon.technology"
POLYGON_AMOY_RPC_NODES = "https://rpc-amoy.polygon.technology,https://rpc.ankr.com/polygon_amoy,https://polygon-amoy.blockpi.network/v1/rpc/public"

# POL阈值
POL_THRESHOLD = "0.01"  # 原: BNB_THRESHOLD = "0.0005"

# XPD代币
TOKEN_XPD = "0x35774A4E1fFEee74Fa3859F89cfae00b3aC8C3A8"  # 原: TOKEN_WKEYDAO

# 安全钱包
SAFE_WALLET = "0x2a71e200d13558631831c3e78e88afde8464f761"  # 原: 0xFB9Aa9...

# Gas补充钱包
GAS_FUNDING_WALLET = "0x633be54ef2c776bedd8555afc1375847e4b5d8f3"
```

### 环境变量说明

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `PROTECTED_WALLETS` | 被保护钱包地址（逗号分隔） | `0x32af405726ba6bd2f9b7ecdfed3bdd9b590c0939` |
| `POL_THRESHOLD` | POL余额阈值（触发应急） | `0.01` |
| `TOKEN_XPD` | XPD代币合约地址 | `0x35774A4E1fFEee74Fa3859F89cfae00b3aC8C3A8` |
| `SAFE_WALLET` | 安全钱包地址（接收转移资产） | `0x2a71e200d13558631831c3e78e88afde8464f761` |
| `GAS_FUNDING_WALLET` | Gas费补充钱包地址 | `0x633be54ef2c776bedd8555afc1375847e4b5d8f3` |

### Secrets 配置

需要通过 `wrangler secret put` 配置的密钥：

| 密钥名 | 说明 |
|--------|------|
| `API_KEY` | API密钥，保护POST端点 |
| `SUPABASE_URL` | Supabase项目URL |
| `SUPABASE_KEY` | Supabase服务密钥 |
| `WALLET_PRIVATE_KEY_32af...` | 被保护钱包私钥（按地址配置） |
| `SAFE_WALLET_PRIVATE_KEY` | 安全钱包私钥 |
| `GAS_FUNDING_WALLET_PRIVATE_KEY` | Gas费补充钱包私钥 |

---

## 前端集成

### API基础URL

```
https://tactics-1.xplan2026.workers.dev
```

### 使用示例

#### 1. 获取钱包状态

```javascript
const response = await fetch('https://tactics-1.xplan2026.workers.dev/status')
const data = await response.json()

console.log(data.wallets[0].pol_balance)
console.log(data.wallets[0].xpd_balance)
```

#### 2. 触发测试转账（前端"开始测试"按钮）

```javascript
const response = await fetch('https://tactics-1.xplan2026.workers.dev/test/transfer', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-API-Key': '<your-api-key>'
  },
  body: JSON.stringify({ amount: 10 })
})

const data = await response.json()
console.log('交易哈希:', data.tx_hash)
```

#### 3. 启用应急模式

```javascript
const response = await fetch('https://tactics-1.xplan2026.workers.dev/emergency/enable', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-API-Key': '<your-api-key>'
  },
  body: JSON.stringify({})
})

const data = await response.json()
console.log('应急模式:', data.emergency_mode)
```

---

## 部署步骤

### 1. 配置Secrets

```bash
# 设置API密钥
cd cloudflare/tactics-1
npx wrangler secret put API_KEY

# 设置Supabase配置
npx wrangler secret put SUPABASE_URL
npx wrangler secret put SUPABASE_KEY

# 设置钱包私钥（按地址）
npx wrangler secret put WALLET_PRIVATE_KEY_32af405726ba6bd2f9b7ecdfed3bdd9b590c0939

# 设置安全钱包私钥
npx wrangler secret put SAFE_WALLET_PRIVATE_KEY

# 设置Gas费钱包私钥
npx wrangler secret put GAS_FUNDING_WALLET_PRIVATE_KEY
```

### 2. 部署Worker

```bash
cd cloudflare/tactics-1
export CLOUDFLARE_API_TOKEN="<your-token>"
export CLOUDFLARE_ACCOUNT_ID="1b9f2ccbdc655cf10384c9ef205b6eab"
npx wrangler deploy
```

### 3. 验证部署

```bash
# 健康检查
curl https://tactics-1.xplan2026.workers.dev/health

# 查看状态
curl https://tactics-1.xplan2026.workers.dev/status

# 查看API文档
curl https://tactics-1.xplan2026.workers.dev/api-docs
```

---

## 注意事项

### 1. XPD代币精度

XPD代币的精度为 **9**（不是18），在计算和转账时需要注意：

```javascript
// 正确的计算方式
const decimals = 9
const transferAmount = ethers.parseUnits(amount.toString(), decimals)
```

### 2. 应急模式触发条件

当被保护钱包的 **POL余额 > 0.01** 时，自动触发应急状态，扫描间隔从60秒变为5秒。

### 3. 测试转账

`/test/transfer` 端点将XPD从**安全钱包**转账到**被保护钱包**，用于演示资产转移功能。

### 4. API认证

所有POST端点都需要 `X-API-Key` 请求头，请确保在前端请求中包含正确的API密钥。

---

## 待办事项

- [ ] 配置Cloudflare Workers的KV命名空间ID
- [ ] 配置所有钱包私钥到Wrangler Secrets
- [ ] 测试所有API端点
- [ ] 前端集成测试
- [ ] 部署到生产环境

---

**文档维护者**: Development Team
**最后更新**: 2026-02-07
