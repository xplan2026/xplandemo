# 前端双模式部署指南

## 概述

本项目支持两种前端部署模式：

| 模式 | 用途 | 访问地址 | 触发条件 |
|------|------|----------|----------|
| **Staging** | 开发阶段预览 | http://182.254.180.26:6060 | master 分支推送 |
| **Production** | 正式发布 | https://xplan-official.pinit.eth.limo | main 分支推送 |

## 工作流文件

- `.github/workflows/deploy-frontend.yml` - 服务器部署（Staging）
- `.github/workflows/deploy-frontend-dual.yml` - 双模式部署（Staging + Production）

## 前置条件

### GitHub Secrets 配置

需要在 GitHub 仓库配置以下 Secrets：

#### 服务器部署相关
| Secret 名称 | 说明 | 示例 |
|-------------|------|------|
| `SSH_HOST` | 服务器 IP 地址 | `182.254.180.26` |
| `SSH_USER` | SSH 用户名 | `ubuntu` |
| `SSH_PRIVATE_KEY` | SSH 私钥 | `-----BEGIN OPENSSH PRIVATE KEY-----\n...` |

#### PinMe 部署相关
| Secret 名称 | 说明 | 示例 |
|-------------|------|------|
| `PINME_APPKEY` | PinMe 应用密钥 | `0x123...-jwt-token...` |

## 获取 PinMe AppKey

1. 访问 [PinMe 官网](https://pinme.eth.limo/)
2. 连接钱包并注册账号
3. 进入 **Settings → API Keys**
4. 生成或复制 AppKey
5. 格式：`<address>-<jwt-token>`

## 部署流程

### 自动部署（推荐）

#### Staging 部署
```bash
# 推送到 master 分支
git push origin master
```

#### Production 部署
```bash
# 推送到 main 分支
git push origin main
```

### 手动部署

1. 进入 GitHub 仓库的 **Actions** 页面
2. 选择 **Deploy Frontend (Dual Mode)** 工作流
3. 点击 **Run workflow**
4. 选择环境（production 或 staging）
5. 点击 **Run workflow** 按钮

## 部署详情

### Staging 部署到 Ubuntu 服务器

**部署内容**：
- `frontend/official-site/dist/` → `/var/www/xplan-demo/official-site/`
- `frontend/DemoSite/` → `/var/www/xplan-demo/DemoSite/`

**执行步骤**：
1. 构建官网（`npm run build`）
2. 使用 rsync 同步文件到服务器
3. 设置文件权限（ubuntu:www-data）
4. 重新加载 Nginx
5. 健康检查

**访问地址**：http://182.254.180.26:6060

### Production 部署到 PinMe

**部署内容**：
- `frontend/official-site/dist/` → IPFS（PinMe）
- `frontend/DemoSite/` → IPFS（PinMe）

**执行步骤**：
1. 构建官网（`npm run build`）
2. 安装 PinMe CLI
3. 上传到 PinMe（自动获得新 CID）
4. 生成部署摘要

**访问地址**：
- 官网：https://xplan-official.pinit.eth.limo
- Demo：https://xplan-demo.pinit.eth.limo

**注意**：每次部署都会生成新的 CID 和预览链接

## PinMe 免费计划限制

| 项目 | 限制 |
|------|------|
| 单文件大小 | 最大 200MB |
| 总存储空间 | 1GB |
| 内容类型 | 仅静态文件 |
| 更新方式 | 需要重新上传 |

## 查看部署历史

### PinMe 部署历史

```bash
# 本地安装 PinMe CLI
npm install -g pinme

# 设置 AppKey
pinme set-appkey "your-appkey"

# 查看上传历史
pinme list

# 查看某次部署详情
pinme info <cid>
```

### GitHub Actions 历史

1. 进入 GitHub 仓库的 **Actions** 页面
2. 查看 **Deploy Frontend (Dual Mode)** 工作流运行记录
3. 点击具体运行记录查看日志

## 常见问题

### 1. PinMe 部署失败：AppKey authentication failed

**原因**：`PINME_APPKEY` 配置错误或过期

**解决**：
1. 登录 PinMe 官网，重新生成 AppKey
2. 更新 GitHub Secrets 中的 `PINME_APPKEY`

### 2. 服务器部署失败：Permission denied

**原因**：SSH 私钥配置错误或用户权限不足

**解决**：
1. 确认 `SSH_PRIVATE_KEY` 正确
2. 确认 `SSH_USER` 为 `ubuntu`
3. 检查服务器上 ubuntu 用户是否有相应权限

### 3. 构建失败：Build directory not found

**原因**：`npm run build` 失败或构建目录不存在

**解决**：
1. 检查 `package.json` 中的 `build` 脚本
2. 确认构建输出目录（默认为 `dist`）
3. 查看 GitHub Actions 日志了解详细错误

### 4. PinMe 部署后访问地址不同

**原因**：PinMe 免费计划每次部署生成新 CID

**解决**：
- 开发阶段：使用预览链接进行测试
- 正式发布：使用自定义域名（需绑定）
- 文档更新：记录最新 CID 或预览链接

## 自定义域名绑定（可选）

### PinMe 自定义域名

PinMe 支持绑定自定义 ENS 域名，需要配置 ENS 解析指向 IPFS。

### 服务器自定义域名

Nginx 配置文件位于 `server-configs/xplan-demo.conf`。

## 最佳实践

### 开发流程

1. **本地开发**：使用 `npm run dev` 本地调试
2. **Staging 预览**：推送到 master 分支，验证功能
3. **Production 发布**：验证通过后推送到 main 分支

### 分支管理

- `master` - 开发分支，自动部署到 Staging
- `main` - 生产分支，自动部署到 Production

### 代码审查

在推送到 `main` 分支前，建议：
1. 在 Staging 环境充分测试
2. 进行代码审查
3. 确认版本号更新

## 监控与维护

### Staging 环境

```bash
# 登录服务器
ssh -i ~/.ssh/xplan_server_key ubuntu@182.254.180.26

# 查看 Nginx 日志
sudo tail -f /var/log/nginx/access.log

# 重启 Nginx
sudo systemctl restart nginx
```

### Production 环境

使用 PinMe CLI 管理部署：
```bash
pinme list
pinme info <cid>
```

---

**最后更新**：2026-02-08
**文档版本**：1.0
