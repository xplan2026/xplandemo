# X-plan Demo 完整部署指南

## 环境说明

- **开发环境**: 笔记本电脑
- **服务器**: Ubuntu 20.04 (182.254.180.26)
- **端口**: 6060

---

## 任务清单

### ✅ 已完成

1. ✅ 重构 DemoSite 为侧边栏布局（三个页面）
2. ✅ 实现官网 Web3 登录与 DemoSite 跨域鉴权
3. ✅ 创建 Smart 目录开发智能合约防盗币功能
4. ✅ 配置 GitHub Actions 自动部署 Worker
5. ✅ 配置 Ubuntu 服务器 Nginx（端口 6060）
6. ✅ 配置 GitHub Actions 自动部署前端到 Ubuntu 服务器
7. ✅ 配置前端 build 和 IPFS 部署

---

## 一、Ubuntu 服务器配置

### 1.1 初始化服务器

```bash
# 连接到服务器
ssh root@182.254.180.26

# 下载并执行初始化脚本
cd /tmp
git clone https://github.com/xplan2026/xplandemo.git
cd xplandemo
chmod +x server-configs/setup-server.sh
./server-configs/setup-server.sh
```

### 1.2 手动部署前端（首次）

```bash
# 在本地笔记本执行
cd d:/TOBEHOST/xplan2026

# 首次需要手动配置 SSH 密钥
# 1. 生成 SSH 密钥
ssh-keygen -t rsa -b 4096 -C "xplan2026"

# 2. 复制公钥到服务器
ssh-copy-id -p 22 root@182.254.180.26

# 3. 执行部署脚本
chmod +x server-configs/deploy-frontend.sh
./server-configs/deploy-frontend.sh
```

### 1.3 验证部署

```bash
# 访问健康检查端点
curl http://182.254.180.26:6060/health

# 应该返回: OK
```

---

## 二、GitHub Actions 配置

### 2.1 Worker 自动部署

**文件**: `.github/workflows/deploy-worker.yml`

**触发条件**:
- 推送到 `master` 分支
- 修改 `cloudflare/tactics-1/**` 文件

**需要的 Secrets**:
- `CLOUDFLARE_API_TOKEN`: Cloudflare API Token
- `CLOUDFLARE_ACCOUNT_ID`: `1b9f2ccbdc655cf10384c9ef205b6eab`

### 2.2 前端自动部署到 Ubuntu

**文件**: `.github/workflows/deploy-frontend.yml`

**触发条件**:
- 推送到 `master` 分支
- 修改 `frontend/` 目录

**需要的 Secrets**:
- `SSH_PRIVATE_KEY`: 服务器的 SSH 私钥

**配置步骤**:

1. **生成 SSH 密钥**（如果还没有）:
   ```bash
   ssh-keygen -t rsa -b 4096 -C "github-actions" -f ~/.ssh/github_actions_rsa
   ```

2. **添加公钥到服务器**:
   ```bash
   ssh-copy-id -i ~/.ssh/github_actions_rsa.pub root@182.254.180.26
   ```

3. **在 GitHub 添加 Secret**:
   - 访问: https://github.com/xplan2026/xplandemo/settings/secrets/actions
   - 添加 Secret: `SSH_PRIVATE_KEY`
   - 内容: `~/.ssh/github_actions_rsa` 的私钥内容

### 2.3 IPFS 部署

**文件**: `.github/workflows/build-and-deploy-ipfs.yml`

**触发条件**:
- 推送标签（如 `v1.0.0`）
- 手动触发

**需要的 Secrets**:
- `PINATA_API_KEY`: Pinata API Key
- `PINATA_API_SECRET`: Pinata API Secret
- `PINATA_JWT`: Pinata JWT Token

---

## 三、本地部署

### 3.1 部署 Worker

```bash
cd d:/TOBEHOST/xplan2026/cloudflare/tactics-1

# 方法 1: 使用 wrangler（需要 Node.js）
npx wrangler deploy

# 方法 2: 使用脚本
PowerShell -ExecutionPolicy Bypass -File quick-deploy.ps1
```

### 3.2 部署前端到 Ubuntu

```bash
cd d:/TOBEHOST/xplan2026

# 使用部署脚本
chmod +x server-configs/deploy-frontend.sh
./server-configs/deploy-frontend.sh
```

### 3.3 部署到 IPFS

```bash
cd d:/TOBEHOST/xplan2026

# 方法 1: 使用 GitHub Actions
# 推送标签: git tag v1.0.0 && git push origin v1.0.0

# 方法 2: 本地部署
# 首先构建
cd frontend/official-site
npm run build

# 返回项目根目录
cd ../..

# 执行 IPFS 部署
chmod +x server-configs/deploy-ipfs.sh
./server-configs/deploy-ipfs.sh
```

---

## 四、Smart 合约部署

### 4.1 安装依赖

```bash
cd d:/TOBEHOST/xplan2026/Smart
npm install
```

### 4.2 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件，填入真实值
# POLYGON_AMOY_RPC_URL=https://rpc-amoy.polygon.technology
# PRIVATE_KEY=your_private_key
# POLYGONSCAN_API_KEY=your_polygonscan_api_key
```

### 4.3 编译合约

```bash
npm run compile
```

### 4.4 部署合约

```bash
npm run deploy:testnet
```

### 4.5 验证合约

```bash
# 在 Polygonscan 上验证合约
npm run verify:testnet -- <contract-address>
```

---

## 五、功能使用

### 5.1 官网 Web3 登录

1. 访问 http://182.254.180.26:6060
2. 点击右上角"连接钱包"
3. 使用 MetaMask 连接钱包
4. 连接成功后，可以访问所有页面

### 5.2 DemoSite 跨域鉴权

1. 在官网连接钱包后，点击"演示/Demo"
2. 点击"进入演示系统"按钮
3. 系统会打开新窗口并传递钱包连接信息
4. DemoSite 显示已连接的钱包地址

### 5.3 DemoSite 三个页面

- **机器人抢跑**: 使用 Cloudflare Worker 保护资产
- **智能合约防盗币**: 使用智能合约保护资产
- **操作指南**: 查看使用文档和 FAQ

---

## 六、故障排查

### 6.1 部署失败

**问题**: GitHub Actions 部署失败

**解决方案**:
1. 检查 SSH 密钥是否正确配置
2. 确认服务器防火墙允许 22 端口
3. 查看 Actions 日志获取详细错误

### 6.2 Nginx 配置错误

**问题**: Nginx 重启失败

**解决方案**:
```bash
# 在服务器上测试配置
nginx -t

# 查看错误日志
tail -f /var/log/nginx/error.log
```

### 6.3 Worker 部署失败

**问题**: Worker 部署失败

**解决方案**:
1. 检查 Cloudflare API Token 权限
2. 确认 Account ID 正确
3. 查看 Worker 日志

---

## 七、安全注意事项

1. **绝不提交敏感信息**:
   - SSH 私钥
   - 钱包私钥
   - API Token
   - 环境变量文件

2. **定期更新密钥**:
   - SSH 密钥（每 3-6 个月）
   - API Token（每 3-6 个月）
   - 钱包私钥（如怀疑泄露）

3. **使用最小权限原则**:
   - GitHub Actions 仅授予必要的权限
   - Cloudflare Token 仅授予必要的权限

---

## 八、下一步

- [ ] 添加单元测试
- [ ] 添加集成测试
- [ ] 配置监控和告警
- [ ] 添加 CI/CD 中的自动化测试
- [ ] 配置域名和 SSL 证书

---

**最后更新**: 2026-02-08
