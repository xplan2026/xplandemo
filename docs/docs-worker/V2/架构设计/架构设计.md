# guard-plus 架构设计

## 方案概述

采用**客户端轮询方案**实现高频扫描，保持 Cloudflare Workers 免费套餐使用。

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户前端                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  任务管理界面                                            │  │
│  │  - 创建任务（输入涡轮开始时间）                          │  │
│  │  - 查看任务状态                                          │  │
│  │  - 实时监控余额                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                          ↓ 轮询（5秒/30秒）                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  轮询调度器                                              │  │
│  │  - 检查任务状态                                          │  │
│  │  - 检查余额变化                                          │  │
│  │  - 触发转账操作                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                          ↓ HTTP API
┌─────────────────────────────────────────────────────────────────┐
│              guard-plus-worker (Cloudflare)                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  API 接口                                                │  │
│  │  - POST /tasks          创建任务                          │  │
│  │  - GET  /tasks          获取任务列表                      │  │
│  │  - GET  /scan           执行扫描                          │  │
│  │  - POST /transfer       触发转账                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  安全控制                                                │  │
│  │  - IP 白名单检查                                         │  │
│  │  - 域名白名单检查                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                          ↓ REST API
┌─────────────────────────────────────────────────────────────────┐
│              Supabase 数据库                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  guard_tasks 表                                          │  │
│  │  - 扫描任务记录                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  transactions 表（复用）                                  │  │
│  │  - 交易记录                                              │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 目录结构

```
guard-plus/
├── guard-plus-worker/              # Cloudflare Worker 后端
│   ├── src/
│   │   ├── index.js              # 入口文件
│   │   ├── api/
│   │   │   ├── tasks.js          # 任务管理 API
│   │   │   └── scan.js           # 扫描 API
│   │   ├── lib/
│   │   │   ├── supabase.js       # Supabase 客户端
│   │   │   ├── scanner.js        # 扫描器
│   │   │   ├── transfer.js       # 转账管理器
│   │   │   └── security.js       # 安全控制（IP/域名白名单）
│   │   └── middleware.js         # 中间件
│   ├── wrangler.toml             # Worker 配置
│   └── package.json
├── frontend/                      # 前端管理界面
│   ├── src/
│   │   ├── components/           # Vue 组件
│   │   │   ├── TaskForm.vue     # 任务创建表单
│   │   │   ├── TaskList.vue     # 任务列表
│   │   │   └── BalanceMonitor.vue # 余额监控
│   │   ├── api/
│   │   │   └── worker.js        # Worker API 调用
│   │   ├── utils/
│   │   │   └── poller.js        # 轮询调度器
│   │   ├── App.vue
│   │   └── main.js
│   ├── package.json
│   └── vite.config.js
└── docs/
    ├── 架构设计.md               # 本文档
    ├── API文档.md
    └── 部署指南.md
```

## 守卫逻辑流程

### 1. 任务创建流程

```
用户输入：
- 钱包地址（3个被监控钱包之一）
- 涡轮开始时间

后端处理：
1. 计算触发扫描时间 = 涡轮开始时间 + 11.5 小时
2. 创建任务记录到 Supabase
3. 返回任务 ID

前端响应：
- 显示任务已创建
- 显示预计触发扫描时间
```

### 2. 扫描轮询流程

```
默认状态（每 30 秒轮询一次）：
前端 → Worker API /scan → 检查余额 → 返回结果
     ↓
  检查任务状态（是否到达扫描时间）

检测到 BNB 增加：
前端 → Worker API /scan
     ↓
  返回 high_freq_until 时间戳
     ↓
  前端切换为 5 秒轮询
     ↓
  持续 10 分钟
     ↓
  恢复 30 秒轮询

检测到 wkeyDAO 变化：
前端 → Worker API /scan
     ↓
  返回 shouldTransfer=true
     ↓
  前端调用 POST /transfer
     ↓
  执行转账
     ↓
  任务状态 = completed
     ↓
  停止轮询
```

### 3. 安全控制机制

#### Worker 端安全检查

```javascript
// 请求白名单检查
function checkAccess(request, env) {
  const allowedIPs = env.ALLOWED_IPS?.split(',') || []
  const allowedDomains = env.ALLOWED_DOMAINS?.split(',') || []
  
  // IP 白名单检查
  const clientIP = request.headers.get('CF-Connecting-IP')
  if (allowedIPs.length > 0 && !allowedIPs.includes(clientIP)) {
    return { allowed: false, reason: 'IP not whitelisted' }
  }
  
  // 域名白名单检查（通过 Referer 或 Origin）
  const referer = request.headers.get('Referer')
  const origin = request.headers.get('Origin')
  if (allowedDomains.length > 0) {
    const isAllowed = [...allowedDomains, ...allowedDomains.map(d => `https://${d}`)]
      .some(domain => referer?.includes(domain) || origin?.includes(domain))
    if (!isAllowed) {
      return { allowed: false, reason: 'Domain not whitelisted' }
    }
  }
  
  return { allowed: true }
}
```

#### 前端额外保护

```javascript
// API 调用添加认证 token
const API_TOKEN = localStorage.getItem('guard-api-token')
axios.defaults.headers.common['X-Guard-Token'] = API_TOKEN
```

## API 设计

### 创建任务

```http
POST /api/tasks
Content-Type: application/json

{
  "wallet_address": "0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89",
  "vortex_start_time": "2026-01-15T12:00:00Z"
}

Response:
{
  "success": true,
  "task_id": 123,
  "scheduled_scan_time": "2026-01-15T23:30:00Z"
}
```

### 扫描余额

```http
GET /api/scan?wallet_address=0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89

Response:
{
  "wallet_address": "0x886b...",
  "bnb_balance": "0.1234",
  "bnb_increased": false,
  "wkeydao_balance": "100.5",
  "wkeydao_changed": false,
  "high_freq_until": null,  // 如果 BNB 增加，返回截止时间
  "should_transfer": false,
  "timestamp": 1705296000000
}
```

### 触发转账

```http
POST /api/transfer
Content-Type: application/json

{
  "wallet_address": "0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89"
}

Response:
{
  "success": true,
  "tx_hash": "0xabc123..."
}
```

## 轮询策略

### 前端轮询器状态机

```javascript
const POLL_INTERVALS = {
  NORMAL: 30000,    // 30 秒（默认）
  HIGH: 5000        // 5 秒（高频）
}

const poller = {
  mode: 'NORMAL',   // NORMAL | HIGH
  timer: null,
  
  async poll() {
    const result = await api.scan(walletAddress)
    
    if (result.bnb_increased && this.mode === 'NORMAL') {
      // BNB 增加，切换到高频模式
      this.switchToHighFreq(result.high_freq_until)
    }
    
    if (result.should_transfer) {
      // wkeyDAO 变化，触发转账
      await this.triggerTransfer()
      this.stop()
      return
    }
    
    // 继续轮询
    this.scheduleNext()
  },
  
  switchToHighFreq(until) {
    this.mode = 'HIGH'
    const remaining = until - Date.now()
    setTimeout(() => this.switchToNormal(), remaining)
  },
  
  scheduleNext() {
    const interval = this.mode === 'HIGH' ? POLL_INTERVALS.HIGH : POLL_INTERVALS.NORMAL
    this.timer = setTimeout(() => this.poll(), interval)
  }
}
```

## 数据库设计

### guard_tasks 表

```sql
CREATE TABLE guard_tasks (
  id BIGSERIAL PRIMARY KEY,
  wallet_address VARCHAR(42) NOT NULL,
  vortex_start_time TIMESTAMP WITH TIME ZONE NOT NULL,
  scheduled_scan_time TIMESTAMP WITH TIME ZONE NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  -- status: pending, active, completed, failed
  
  -- 高频扫描控制
  high_freq_until TIMESTAMP WITH TIME ZONE,
  
  -- 元数据
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE,
  
  -- 索引
  CONSTRAINT valid_wallet CHECK (wallet_address IN (
    '0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89',
    '0x3D3914960567b3A253C429d5Ab81DA1F386F9111',
    '0x9F4fb2E9F0bb920EFceE6ca21ebf1B6A2f8D8e16'
  ))
);

CREATE INDEX idx_guard_tasks_status ON guard_tasks(status);
CREATE INDEX idx_guard_tasks_wallet ON guard_tasks(wallet_address);
CREATE INDEX idx_guard_tasks_scheduled ON guard_tasks(scheduled_scan_time);
```

### wkeyDAO 代币配置

```javascript
const WKEYDAO_TOKEN = {
  address: '0x194B302a4b0a79795Fb68E2ADf1B8c9eC5ff8d1F',
  decimals: 18,
  symbol: 'wkeyDAO'
}
```

## 部署配置

### 环境变量（wrangler.toml）

```toml
[vars]
BSC_RPC = "https://bsc-rpc.publicnode.com"
WKEYDAO_TOKEN = "0x194B302a4b0a79795Fb68E2ADf1B8c9eC5ff8d1F"

# 安全配置
ALLOWED_IPS = ""               # 如有需要配置，逗号分隔
ALLOWED_DOMAINS = ""           # 如有需要配置，逗号分隔

# Supabase
SUPABASE_URL = "your-project-url"
SUPABASE_KEY = "your-anon-key"

# 密钥（通过 secret 设置）
# SAFE_WALLET
# PRIVATE_KEY_0x886b...  (每个钱包一个私钥)
```

## 安全考虑

1. **IP/域名白名单**：仅允许特定来源访问 API
2. **HTTPS 强制**：前端使用 HTTPS 访问
3. **请求频率限制**：Worker 端添加基础 rate limiting
4. **私钥安全**：存储在 Cloudflare Workers Secrets 中
5. **错误信息脱敏**：不泄露系统内部信息

## 监控和日志

- Worker 日志：通过 Cloudflare Dashboard 查看
- 前端错误：控制台日志 + 可选的远程上报
- Supabase 审计：记录所有交易和任务变更
