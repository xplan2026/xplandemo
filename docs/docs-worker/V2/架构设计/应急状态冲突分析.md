# 应急状态冲突分析

## 日期
2026-01-19

---

## 当前各Worker的应急状态实现

### Worker-1: Interception

**触发方式**: 直接转账，不进入应急状态

**实现**:
```javascript
// scheduled() 中
const shouldTransfer = this._shouldTransfer(scanResult)
if (shouldTransfer) {
  await this._executeTransfer(wallet, transferManager, db, shouldTransfer.reason)
}
```

**特点**:
- ❌ 不进入应急状态
- ✅ 直接调用`TransferManager.emergencyTransfer()`
- ✅ 转账完成后立即结束

---

### Worker-2: Scheduler

**触发方式**: 定时任务触发，写入应急状态到KV

**实现**:
```javascript
// triggerEmergencyState()
await env.EMERGENCY_STORE.put('emergency_state', JSON.stringify({
  triggered: true,
  triggerSource: 'worker-2-scheduler',
  triggerReason: 'timer_task',
  triggeredAt: new Date().toISOString(),
  task: { ... }
}), { expirationTtl: 600 })
```

**特点**:
- ✅ 写入应急状态到KV
- ✅ 记录到`emergency_events`表
- ❌ 只触发，不执行转账
- ❌ 需要其他Worker来消费应急状态

---

### Worker-3: Surveillance

**触发方式**: 发现盗币者转账，写入应急状态到KV

**实现**:
```javascript
// triggerEmergencyState()
if (env.BLOCK_STORE) {
  await env.BLOCK_STORE.put('emergency_state', JSON.stringify({
    triggered: true,
    triggerSource: 'worker-3-surveillance',
    triggeredAt: new Date().toISOString(),
    transferDetails: transferDetails
  }), { expirationTtl: 600 })
}
```

**特点**:
- ✅ 写入应急状态到KV
- ❌ 只触发，不执行转账
- ❌ 需要其他Worker来消费应急状态
- ❌ 使用`BLOCK_STORE`而非`EMERGENCY_STORE`

---

### Worker-4: Turbine

**触发方式**: 发现涡轮合约转账，写入应急状态到KV

**实现**:
```javascript
// triggerEmergencyState()
if (env.BLOCK_STORE) {
  await env.BLOCK_STORE.put('emergency_state', JSON.stringify({
    triggered: true,
    triggerSource: 'worker-4-turbine',
    triggeredAt: new Date().toISOString(),
    transferDetails: transferDetails
  }), { expirationTtl: 600 })
}
```

**特点**:
- ✅ 写入应急状态到KV
- ❌ 只触发，不执行转账
- ❌ 需要其他Worker来消费应急状态
- ❌ 使用`BLOCK_STORE`而非`EMERGENCY_STORE`

---

## 冲突和差异

### ❌ 冲突1：Worker-1与其他Worker的行为不同

| Worker | 是否进入应急状态 | 执行方式 |
|--------|---------------|---------|
| Worker-1 | ❌ 不进入 | 直接转账 |
| Worker-2 | ✅ 进入 | 写入KV（无消费者） |
| Worker-3 | ✅ 进入 | 写入KV（无消费者） |
| Worker-4 | ✅ 进入 | 写入KV（无消费者） |

**问题**:
- Worker-1直接转账，而Worker-2/3/4只触发不执行
- Worker-2/3/4写入的应急状态没有Worker来消费

---

### ❌ 冲突2：KV命名空间不一致

| Worker | 使用的KV | Key名称 |
|--------|---------|---------|
| Worker-2 | `EMERGENCY_STORE` | `emergency_state` |
| Worker-3 | `BLOCK_STORE` | `emergency_state` |
| Worker-4 | `BLOCK_STORE` | `emergency_state` |

**问题**:
- Worker-2使用`EMERGENCY_STORE`
- Worker-3/4使用`BLOCK_STORE`
- 应该统一使用同一个KV命名空间

---

### ❌ 冲突3：缺少应急状态消费者

**问题**:
- Worker-2/3/4都写入了应急状态到KV
- 但没有任何Worker来消费这些应急状态
- 导致应急状态被触发后，没有实际转账动作

---

### ❌ 冲突4：与优化方案不符

**优化方案要求**:
```
- step1. 盗币者转入BNB → Worker-3检测 → 触发应急状态
- step2. 涡轮结束前30分钟 → Worker-2触发 → 触发应急状态
- step3. wkeyDAO进入钱包 → Worker-1检测 → 直接转账（不进入应急状态）
- step4. 涡轮合约转入wkeyDAO → Worker-4检测 → 触发应急状态
```

**实际实现**:
- Worker-3/4触发了应急状态，但没有消费者
- Worker-1不进入应急状态，直接转账

---

## 解决方案讨论

### 方案A：Worker-1成为应急状态消费者（推荐）

**设计**:
1. Worker-1每分钟检查应急状态KV
2. 如果发现应急状态被触发，进入应急模式
3. 应急模式下执行高频扫描和转账

**实现**:
```javascript
// Worker-1 scheduled()
const emergencyState = await env.EMERGENCY_STORE.get('emergency_state')
if (emergencyState) {
  // 进入应急模式
  await emergency.runEmergencyLoop({ ... })
} else {
  // 正常扫描 + 直接转账
  const shouldTransfer = this._shouldTransfer(scanResult)
  if (shouldTransfer) {
    await this._executeTransfer(...)
  }
}
```

**优点**:
- ✅ 统一使用`EMERGENCY_STORE`
- ✅ Worker-1成为应急状态消费者
- ✅ 符合优化方案：Worker-1既支持直接转账，也支持应急状态

**缺点**:
- Worker-1需要同时支持两种模式
- 需要处理分布式锁（防止重复进入应急状态）

---

### 方案B：创建独立的应急状态Worker

**设计**:
1. 创建Worker-5：EmergencyHandler
2. Worker-5监听应急状态KV
3. 应急状态被触发时，Worker-5进入应急循环并转账

**优点**:
- ✅ 职责分离，Worker-1只负责直接转账
- ✅ Worker-5专门处理应急状态

**缺点**:
- 增加了一个Worker
- 需要协调Worker-1和Worker-5的转账逻辑

---

### 方案C：修改Worker-1，移除直接转账逻辑

**设计**:
1. Worker-1只通过应急状态来转账
2. Worker-1扫描发现BNB增加或wkeyDAO>0时，先触发应急状态
3. 然后进入应急状态循环

**优点**:
- ✅ 统一逻辑：所有转账都通过应急状态

**缺点**:
- ❌ 与优化方案不符（优化方案明确说Worker-1直接转账）
- 增加延迟（先触发应急状态，再进入应急循环）

---

## 我的推荐

**推荐方案A：Worker-1成为应急状态消费者**

**理由**:
1. 符合优化方案要求
2. 减少Worker数量（不需要Worker-5）
3. Worker-1既有直接转账能力，也有应急状态处理能力

**需要修改的文件**:
1. `cloudflare/worker-1-interception/src/index.js` - 添加应急状态检查逻辑
2. `cloudflare/worker-3-surveillance/src/index.js` - 统一使用`EMERGENCY_STORE`
3. `cloudflare/worker-4-turbine/src/index.js` - 统一使用`EMERGENCY_STORE`
4. `cloudflare/worker-2-scheduler/src/index.js` - 已使用`EMERGENCY_STORE`，无需修改
