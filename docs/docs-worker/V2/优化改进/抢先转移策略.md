# Worker-1 Interception

## 概述

Worker-1 Interception 是**抢先转移 Worker**，负责监控被保护钱包，检测到资产转入时立即将资产转移至安全钱包。

## 功能

### 常规扫描
- **频率**：每分钟一次
- **监控内容**：
  - BNB 余额
  - wkeyDAO 余额
- **触发应急状态条件**：
  1. 被保护钱包有新增 BNB
  2. BNB 余额大于 0.001

### 应急状态
- **触发后扫描频率**：每 5 秒一次
- **最大时长**：10 分钟
- **工作流程**：
  1. 进入应急状态
  2. 每 5 秒扫描一次 wkeyDAO 余额
  3. 只要 wkeyDAO 余额 > 0，立即转移 wkeyDAO 和 BNB（扣除 Gas 费）
  4. 将交易记录保存到 Supabase
  5. 退出应急状态

### 数据库集成
- 使用 `DatabaseExtension` 进行数据持久化
- 支持：
  - 白名单鉴权
  - 交易记录保存
  - 错误日志记录
  - KV 缓存（白名单 5 分钟，系统配置 10 分钟）

## 环境变量

### 必需变量（通过 wrangler secret 设置）
- `SAFE_WALLET`: 安全钱包地址
- `SUPABASE_URL`: Supabase 项目 URL
- `SUPABASE_KEY`: Supabase 服务角色密钥
- `JWT_SECRET`: JWT 签名密钥
- `WALLET_PRIVATE_KEY_xxxx`: 各个被保护钱包的私钥

### 可选变量（在 wrangler.toml 中配置）
```toml
WORKER_ID = "worker-1-interception"
WORKER_TYPE = "interception"
BSC_RPC = "https://bsc-rpc.publicnode.com"
WATCHED_WALLETS = "0x886b...,0x3D39..."
EMERGENCY_SCAN_INTERVAL = 5
EMERGENCY_MAX_DURATION = 600
BNB_THRESHOLD = 0.001
TOKEN_BNB = "0x0000000000000000000000000000000000000000"
TOKEN_WKEYDAO = "0x194B302a4b0a79795Fb68E2ADf1B8c9eC5ff8d1F"
WRITE_DELAY_MINUTES = 0
```

## API 接口

### 健康检查
```
GET /health
```

### 钱包详情
```
GET /api/wallets
```

### 交易记录
```
GET /api/transactions?limit=50&offset=0
```

### 手动转账（需要白名单权限）
```
POST /api/transfer
{
  "wallet": "0x...",
  "token": "0x..."  // 可选，不传则转账 BNB
}
```

### Web3 登录
```
POST /api/auth/nonce?address=0x...

POST /api/auth/login
{
  "address": "0x...",
  "nonce": "...",
  "signature": "0x..."
}
```

## 部署

### 1. 安装依赖
```bash
npm install
```

### 2. 配置 wrangler.toml
修改 `account_id` 和其他配置项。

### 3. 设置 Secrets
```bash
wrangler secret put SAFE_WALLET
wrangler secret put SUPABASE_URL
wrangler secret put SUPABASE_KEY
wrangler secret put JWT_SECRET
wrangler secret put WALLET_PRIVATE_KEY_0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89
```

### 4. 部署到 Cloudflare
```bash
npm run deploy
```

### 5. 初始化 Supabase 数据库
```bash
# 在 Supabase SQL Editor 中运行
cat supabase/database-extension-init.sql
```

## 测试

```bash
npm test
```

## 目录结构

```
worker-1-interception/
├── src/
│   ├── index.js                  # 主入口
│   ├── scanner-interception.js   # 拦截扫描器
│   ├── transfer.js               # 转账管理器
│   └── auth.js                   # 认证管理器
├── extensions/
│   └── database/
│       ├── DatabaseExtension.js  # 数据库扩展
│       ├── auth.js               # 鉴权模块
│       ├── transaction.js        # 交易模块
│       ├── system.js             # 系统配置模块
│       └── config.js             # 配置文件
├── wrangler.toml                 # Cloudflare Worker 配置
├── package.json
└── README.md
```

## 数据库表

### whitelist
白名单表，用于鉴权。

### auth_nonce
登录 nonce 表，防止重放攻击。

### transactions
交易记录表，记录所有转账操作。

### errors
错误日志表，记录系统错误。

### rpc_nodes
RPC 节点配置表。

### protected_wallets
被保护钱包配置表。

### hacker_wallets
盗币者钱包配置表。

### contracts
合约地址配置表。

## 注意事项

1. **应急状态自动退出**：10 分钟后自动退出应急状态
2. **转账失败重试**：在应急状态下会持续尝试转账
3. **数据库记录自动清理**：表记录接近 1000 条时自动删除最早 100 条
4. **白名单缓存**：白名单验证使用 KV 缓存，TTL 5 分钟

## 许可证

MIT
