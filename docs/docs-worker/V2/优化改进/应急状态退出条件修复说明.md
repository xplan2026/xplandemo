# 应急状态退出条件修复说明

## 日期
2026-01-22

---

## 背景

### 问题事件
- **时间**: 2026-01-22 02:30
- **事件**: 盗币者盗窃走约 32 个 wkeyDAO
- **触发过程**:
  1. 盗币者先转入 0.002 BNB，我们抢先转账成功 ✅
  2. 此时退出应急状态 ❌（这是关键问题）
  3. 盗币者第二次转入 0.001 BNB
  4. 常规扫描在 1 分钟的空窗期内，没有执行扫描 ❌
  5. 没能检测到 wkeyDAO 余额 > 0（实际是 32 枚）
  6. 盗币者转移 wkeyDAO 成功 ❌

### 版本说明
- **失败版本**: V1.10（只有一个 worker，没有 wkeyDAO 优先转移逻辑）
- **当前版本**: V2.0.1（存在相同的设计缺陷）
- **问题本质**: 应急状态的退出条件错误

---

## 问题分析

### 错误的退出条件

**原设计**（错误）:
```javascript
if (foundWallet) {
  // 触发转账
  await onTransfer({ wallet: foundWallet, reason: 'wkeydao_balance_gt_zero' })

  // ❌ 转账完成后退出应急状态
  await this.exitEmergencyMode('transfer_triggered')
  return { success: true, reason: 'transfer_triggered' }
}
```

**问题**:
1. 转账完成后立即退出应急状态
2. 退出后没有监控，给盗币者第二次转账的机会
3. 常规扫描有 1 分钟的空窗期
4. 盗币者可以利用空窗期盗走 wkeyDAO

### 正确的退出条件

**新设计**（正确）:
```javascript
if (foundWallet) {
  // 触发转账
  await onTransfer({ wallet: foundWallet, reason: 'wkeydao_balance_gt_zero' })

  // ✅ 不退出，继续监控
  console.log(`转账已触发，继续监控...`)
  // 继续循环，不返回
}

// ✅ 检查所有钱包的 wkeyDAO 余额是否都为 0
// 只有所有钱包都没有 wkeyDAO 时才退出应急状态
if (allWkeyDaoZero) {
  console.log(`所有钱包的 wkeyDAO 余额为 0，退出应急状态`)
  await this.exitEmergencyMode('all_wkeydao_zero')
  return { success: true, reason: 'all_wkeydao_zero' }
}
```

**改进**:
1. 转账后不退出，继续监控
2. 检查所有钱包的 wkeyDAO 余额
3. **只有 wkeyDAO=0 才退出**
4. BNB 余额不为 0 也没关系（有 Gas 费）

---

## 修复内容

### 1. 修改 EmergencyExtension

**文件**: `cloudflare/extensions/emergency/EmergencyExtension.js`

**修改位置**: `runEmergencyLoop()` 方法

**修改逻辑**:

```javascript
// 检查是否有钱包的 wkeyDAO 余额 > 0
let foundWallet = null
let allWkeyDaoZero = true

for (const result of scanResults) {
  const wkeyDaoBalance = parseFloat(result.wkeyDaoBalance || '0')
  if (wkeyDaoBalance > 0) {
    foundWallet = result.wallet
    allWkeyDaoZero = false
    console.log(`💰 检测到钱包 ${result.walletShort} 的 wkeyDAO 余额 > 0: ${wkeyDaoBalance}`)
  }
}

if (foundWallet) {
  console.log(`🎯 触发转账条件满足，钱包: ${foundWallet.slice(-4)}`)

  // 调用转账触发回调（不直接转账）
  if (onTransfer) {
    await onTransfer({
      wallet: foundWallet,
      reason: 'wkeydao_balance_gt_zero',
      detectedAt: new Date().toISOString()
    })
  }

  // 如果有内置的转账触发器，也调用
  if (this.onTransferTrigger) {
    await this.onTransferTrigger(foundWallet, 'wkeydao_balance_gt_zero')
  }

  // ✅ 不退出应急状态，继续监控！
  console.log(`🔄 转账已触发，继续监控...`)
  // 继续循环，不返回
}

// ✅ 检查所有钱包的 wkeyDAO 余额是否都为 0
// 只有所有钱包都没有 wkeyDAO 时才退出应急状态
if (allWkeyDaoZero) {
  console.log(`✅ 所有钱包的 wkeyDAO 余额为 0，退出应急状态`)
  await this.exitEmergencyMode('all_wkeydao_zero')
  return { success: true, reason: 'all_wkeydao_zero' }
}
```

### 2. 确认 TransferManager 逻辑

**文件**: `cloudflare/extensions/transfer/Transfer.js`

**确认内容**: wkeyDAO 优先转移逻辑

```javascript
// 1. 先转账 wkeyDAO
try {
  const wkeyDaoTx = await this.transferERC20(wallet, this.wkeyDaoToken)
  if (wkeyDaoTx) {
    results.wkeyDao = { success: true, hash: wkeyDaoTx.hash, amount: wkeyDaoTx.amount }
    console.log(`✅ wkeyDAO 转账成功: ${wkeyDaoTx.hash}`)
  }
} catch (error) {
  console.warn(`⚠️ wkeyDAO 转账失败:`, error.message)
  results.wkeyDao = { success: false, error: error.message }
}

// 2. 转账 BNB（扣除 Gas费）
try {
  const bnbTx = await this.transferBNB(wallet)
  results.bnb = { success: true, hash: bnbTx.hash, amount: bnbTx.amount }
  console.log(`✅ BNB 转账成功: ${bnbTx.hash}, 金额: ${bnbTx.amount} BNB`)
} catch (error) {
  if (error.message.includes('余额不足支付Gas费') || error.message === '余额不足支付Gas费') {
    console.log(`⚠️ BNB 余额不足，跳过转账`)
    results.bnb = { success: false, error: error.message }
  } else {
    throw error
  }
}
```

**确认**: ✅ wkeyDAO 优先转移逻辑已正确实现

---

## 工作流程对比

### 修复前（错误）

```
┌─────────────────────────────────────────────────┐
│         应急状态流程（错误）               │
├─────────────────────────────────────────────────┤
│                                          │
│  盗币者转入 BNB → 触发应急状态          │
│         │                                  │
│         ▼                                  │
│  进入应急循环 (5秒/次)                   │
│         │                                  │
│         ▼                                  │
│  检测到 wkeyDAO>0 → 触发转账            │
│         │                                  │
│         ▼                                  │
│  ❌ 转账完成 → 退出应急状态             │
│         │                                  │
│         ▼                                  │
│  盗币者第二次转入 BNB                       │
│         │                                  │
│         ▼                                  │
│  常规扫描空窗期 (1分钟)                   │
│         │                                  │
│         ▼                                  │
│  ❌ 没能检测到，盗币者盗走 wkeyDAO   │
│                                          │
└─────────────────────────────────────────────────┘
```

### 修复后（正确）

```
┌─────────────────────────────────────────────────┐
│         应急状态流程（正确）               │
├─────────────────────────────────────────────────┤
│                                          │
│  盗币者转入 BNB → 触发应急状态          │
│         │                                  │
│         ▼                                  │
│  进入应急循环 (5秒/次)                   │
│         │                                  │
│         ▼                                  │
│  检测到 wkeyDAO>0 → 触发转账            │
│         │                                  │
│         ▼                                  │
│  ✅ 转账完成 → 继续监控            │
│         │                                  │
│         ▼                                  │
│  盗币者第二次转入 BNB                       │
│         │                                  │
│         ▼                                  │
│  ✅ 再次检测到 wkeyDAO>0 → 再次转账      │
│         │                                  │
│         ▼                                  │
│  ✅ wkeyDAO 转移完成 → wkeyDAO=0          │
│         │                                  │
│         ▼                                  │
│  ✅ 检测到所有钱包 wkeyDAO=0              │
│         │                                  │
│         ▼                                  │
│  ✅ 退出应急状态                         │
│                                          │
└─────────────────────────────────────────────────┘
```

---

## 关键改进点

### 1. 退出条件修改

| 项目 | 修复前 | 修复后 |
|------|--------|--------|
| 退出条件 | 转账完成后退出 | wkeyDAO=0 才退出 |
| 监控方式 | 转账后停止 | 持续监控 |
| 盗币者机会 | 有第二次转账机会 | 无机会 |

### 2. BNB 余额处理

| 项目 | 说明 |
|------|------|
| BNB 不为 0 | 正常情况，有 Gas 费残留 |
| 不影响退出 | 不作为退出条件 |
| 只检查 wkeyDAO | 确保盗币者盗不走 wkeyDAO |

### 3. 扫描频率

| 模式 | 频率 | 说明 |
|------|------|------|
| 应急状态 | 5秒/次 | 高频监控，无空窗期 |
| 常规扫描 | 1分钟/次 | 低频扫描，有空窗期 |

---

## 测试场景

### 场景 1：盗币者一次转入 BNB

```
1. 盗币者转入 0.002 BNB
2. Worker-3 检测到，触发应急状态
3. Worker-1 进入应急循环
4. 检测到 wkeyDAO>0，触发转账
5. wkeyDAO 转移完成
6. 检测到所有钱包 wkeyDAO=0
7. ✅ 退出应急状态
```

### 场景 2：盗币者多次转入 BNB

```
1. 盗币者第一次转入 0.002 BNB
2. Worker-3 检测到，触发应急状态
3. Worker-1 进入应急循环
4. 检测到 wkeyDAO>0（32 枚），触发转账
5. ✅ 不退出，继续监控
6. 盗币者第二次转入 0.001 BNB
7. ✅ 5秒后再次检测到 wkeyDAO>0（0 枚），触发转账
8. 检测到所有钱包 wkeyDAO=0
9. ✅ 退出应急状态
```

### 场景 3：BNB 余额不足

```
1. 盗币者转入 BNB
2. Worker-3 检测到，触发应急状态
3. Worker-1 进入应急循环
4. 检测到 wkeyDAO>0
5. 先转 wkeyDAO（优先）✅
6. 尝试转 BNB，余额不足，跳过
7. BNB 余额 > 0，但 wkeyDAO=0
8. ✅ 退出应急状态
```

---

## 注意事项

1. **wkeyDAO 必须优先转移**
   - 即使 BNB 余额不足，也要先尝试转 wkeyDAO
   - TransferManager 已实现此逻辑

2. **BNB 余额不影响退出**
   - BNB 余额大概率不会为 0（有 Gas 费）
   - 只检查 wkeyDAO=0 作为退出条件

3. **应急状态时长充足**
   - 15 分钟的时长足够应对盗币者的多次操作
   - 宁可长不可短

4. **空窗期问题**
   - 常规扫描每分钟一次，有 1 分钟空窗期
   - 应急状态 5 秒一次，无空窗期
   - 必须尽快进入应急状态

---

## 相关文件

- `cloudflare/extensions/emergency/EmergencyExtension.js` - 应急状态扩展
- `cloudflare/extensions/transfer/Transfer.js` - 转账管理器
- `cloudflare/worker-1-interception/src/index.js` - Worker-1 主逻辑
- `docs/开发指南/错误记录/008-应急状态过早退出.md` - 错误记录

---

**最后更新**: 2026-01-22
