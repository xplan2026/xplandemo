# Worker-3: Surveillance - 监控告警策略

## 功能概述

Worker-3 是监控告警 Worker，用于实时监控链上活动，提供异常检测和告警功能。

## 核心功能

### 1. 实时监控

- **监控对象**: 监控钱包、黑名单地址、可疑交易
- **监控频率**: 实时或定时扫描
- **监控范围**:
  - 钱包余额变化
  - 大额交易检测
  - 黑名单地址交互
  - 可疑合约调用

### 2. 异常检测

#### 余额异常
- 短时间内余额急剧变化
- 非预期资产转入/转出
- 钱包余额归零

#### 交易异常
- 大额交易（超过阈值）
- 频繁小额交易
- 与黑名单地址交互
- 可疑合约调用

### 3. 告警机制

#### 告警级别
- `info`: 信息提醒
- `warning`: 警告
- `danger`: 危险（需要立即处理）

#### 告警方式
- 数据库记录（`alerts` 表）
- 可选：邮件/短信通知（待实现）
- 可选：Webhook 通知（待实现）

#### 告警去重
- 相同类型告警 10 分钟内只发送一次
- 基于 `wallet_address` + `alert_type` + `alert_level` 去重

### 4. 数据库集成

- 使用 DatabaseExtension 统一管理数据
- 告警记录保存到 `alerts` 表
- 支持告警历史查询
- 延迟写入 1 分钟（避免阻塞）

### 5. API 接口

| 端点 | 方法 | 权限 | 说明 |
|------|------|------|------|
| `/health` | GET | 无 | 健康检查 |
| `/api/alerts` | GET | viewer+ | 获取告警列表 |
| `/api/alert` | GET | viewer+ | 获取单个告警 |
| `/api/alert` | PUT | admin | 更新告警状态 |
| `/api/blacklist` | GET | viewer+ | 获取黑名单 |
| `/api/blacklist` | POST | admin | 添加黑名单 |
| `/api/blacklist` | DELETE | admin | 删除黑名单 |
| `/api/scan` | POST | admin | 手动触发扫描 |

## 目录结构

```
worker-3-surveillance/
├── src/
│   ├── index.js                  # 主入口
│   ├── lib/
│   │   ├── monitor.js            # 监控器
│   │   ├── detector.js           # 异常检测器
│   │   ├── alerter.js            # 告警器
│   │   ├── auth.js               # 认证管理器
│   │   └── blacklist.js          # 黑名单管理
│   └── api/                      # API 处理器
├── wrangler.toml                 # Worker 配置
├── package.json                  # 依赖配置（引用根目录）
└── 监控告警策略.md               # 本文件
```

## 部署

### 环境变量配置

```bash
cd worker-3-surveillance

# 设置 Supabase 配置
wrangler secret put SUPABASE_URL
wrangler secret put SUPABASE_KEY
wrangler secret put JWT_SECRET

# 设置 BSC RPC
wrangler secret put BSC_RPC

# 设置监控阈值
wrangler secret put ALERT_BALANCE_THRESHOLD    # 余额变化阈值（单位：BNB）
wrangler secret put ALERT_TRANSACTION_THRESHOLD # 交易金额阈值（单位：BNB）
```

### 部署命令

```bash
# 使用统一命令（在 cloudflare/ 根目录）
npm run deploy:w3

# 或直接部署
cd worker-3-surveillance
npm run deploy
```

## 使用示例

### 查询告警列表

```bash
curl https://your-worker.workers.dev/api/alerts?limit=50&offset=0 \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 更新告警状态

```bash
curl -X PUT https://your-worker.workers.dev/api/alert \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "alert_id",
    "status": "resolved"
  }'
```

### 添加黑名单

```bash
curl -X POST https://your-worker.workers.dev/api/blacklist \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "address": "0x...",
    "reason": "黑客钱包",
    "risk_level": "high"
  }'
```

## 数据库表

### alerts
告警记录表，存储所有告警信息。

### blacklist
黑名单表，记录可疑地址。

### alert_rules
告警规则表，自定义告警规则。

## 与 Worker-1/Worker-2 的配合

| Worker | 主要功能 | 配合方式 |
|--------|----------|----------|
| Worker-1 | 抢先转移 | Worker-3 告警可触发 Worker-1 应急状态 |
| Worker-2 | 定时任务 | Worker-3 监控任务执行情况，告警异常 |
| Worker-3 | 监控告警 | 为 Worker-1/Worker-2 提供告警信息 |

## 注意事项

1. **告警去重**: 避免重复告警，设置合理去重时间
2. **告警阈值**: 根据实际业务设置合理的告警阈值
3. **黑名单管理**: 定期更新黑名单，保持数据准确性
4. **监控频率**: 根据业务需求调整扫描频率

## 监控和日志

- Worker 日志: Cloudflare Dashboard → Workers → Logs
- 告警记录: Supabase `alerts` 表
- 黑名单: Supabase `blacklist` 表
- 错误日志: Supabase `errors` 表

---

**文档版本**: v2.0.0
**维护者**: X-plan 开发团队
