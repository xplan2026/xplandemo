# 扫描器优化说明

## 优化背景

原 Worker 项目在扫描三个钱包时出现 CPU 超限问题（`exceededCpu`）。Guard Plus 采用客户端轮询方案，理论上不会同时扫描多个钱包，但为避免潜在的并发问题，进行了以下优化。

## 优化内容

### 1. 每个钱包独立的 Scanner 实例

**修改文件**: `src/api/scan.js`

引入 `ScannerManager` 类，为每个钱包地址维护独立的 Scanner 实例：

```javascript
class ScannerManager {
  constructor() {
    this.scanners = new Map()
  }

  getScanner(env, walletAddress) {
    const key = walletAddress.toLowerCase()
    if (!this.scanners.has(key)) {
      this.scanners.set(key, new Scanner(env))
    }
    return this.scanners.get(key)
  }
}
```

**优点**:
- 避免多个钱包共享 Scanner 实例导致的竞争
- 每个 Scanner 维护独立的余额缓存
- 支持真正的并发扫描（如果需要）

### 2. 扫描超时保护

**修改文件**: `src/lib/scanner.js`

为所有扫描操作添加 3 秒超时：

```javascript
async scan(walletAddress, timeout = 3000) {
  return Promise.race([
    this._scanInternal(walletAddress),
    this._timeout(timeout, `扫描超时 (${timeout}ms)`)
  ])
}
```

**优点**:
- 防止 RPC 调用卡死导致 CPU 超限
- 快速失败，不影响后续操作
- 与原 Worker 的优化策略一致

### 3. 可观测性配置

**修改文件**: `wrangler.toml`

添加日志配置：

```toml
[observability]
[observability.logs]
enabled = false
invocation_logs = true
```

**说明**:
- `enabled = false`: 禁用实时日志流（减少 CPU 消耗）
- `invocation_logs = true`: 记录调用日志（便于后续分析）

## 与原 Worker 的对比

| 项目 | 原 Worker | Guard Plus |
|-----|----------|-----------|
| 扫描策略 | 轮询（每分钟扫描1个钱包） | 客户端轮询（前端主动触发） |
| Scanner 实例 | 共享 | 每钱包独立 |
| 超时保护 | 3秒扫描/5秒转账 | 3秒扫描 |
| 可观测性 | 未配置 | 已配置 |
| 状态存储 | 内存（无持久化） | 内存 + Supabase 任务表 |

## Guard Plus 的优势

1. **客户端轮询** - 前端一次只监控一个活跃任务，不会同时扫描多个钱包
2. **独立 Scanner** - 即使多个钱包同时被扫描，也不会相互阻塞
3. **超时保护** - 所有扫描操作都有 3 秒超时，避免 RPC 超时导致 CPU 超限
4. **任务持久化** - 守卫任务存储在 Supabase，Worker 重启不丢失

## 测试建议

### 1. 单钱包测试
```bash
# 测试单个钱包扫描
curl "https://guard-plus.3813518962.workers.dev/api/scan?wallet_address=0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89"
```

### 2. 并发测试（验证独立 Scanner）
```bash
# 同时请求三个钱包
curl "https://guard-plus.3813518962.workers.dev/api/scan?wallet_address=0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89" &
curl "https://guard-plus.3813518962.workers.dev/api/scan?wallet_address=0x3D3914960567b3A253C429d5Ab81DA1F386F9111" &
curl "https://guard-plus.3813518962.workers.dev/api/scan?wallet_address=0x9F4fb2E9F0bb920EFceE6ca21ebf1B6A2f8D8e16" &
wait
```

### 3. 超时测试
```bash
# 模拟慢速 RPC，观察 3 秒超时
# 需要修改 BSC_RPC 为一个慢速端点进行测试
```

## 部署信息

- **部署时间**: 2026-01-15
- **Worker 名称**: guard-plus-worker
- **部署 URL**: https://guard-plus.3813518962.workers.dev
- **版本 ID**: 6eb9b9f7-65e9-45c4-afdc-2c043c43bc35
