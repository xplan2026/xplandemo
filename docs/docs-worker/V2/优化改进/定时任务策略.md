# Worker-2: Scheduler - 定时任务 Worker

## 功能概述

Worker-2 是定时任务 Worker，用于执行用户创建的定时扫描任务。主要功能是在涡轮结束前30分钟开始监控，确保资产安全。

## 核心功能

### 1. 定时任务管理

- **任务创建**: 用户输入涡轮结束时间，系统自动计算扫描开始时间（涡轮开始+11.5小时）
- **任务状态**:
  - `pending`: 任务未开始，可修改
  - `scanning`: 任务进行中，常规扫描
  - `emergency`: 应急状态，高频扫描
  - `completed`: 任务已完成
- **任务结束条件**:
  - 达到最大时间（涡轮结束+10分钟）
  - 转账成功后退出

### 2. 扫描机制

#### 常规扫描（每分钟）
- 扫描 BNB 和 wkeyDAO 余额
- 检测余额变化

#### 应急状态（5秒扫描，最多10分钟）
**触发条件**:
- 有新增 BNB
- 或 BNB 余额 > 0.001
- 或 wkeyDAO 余额 > 0

**应急状态工作**:
- 5秒一次扫描 wkeyDAO 余额
- 只要 wkeyDAO 余额 > 0，立即转移 wkeyDAO 和 BNB（扣除 Gas 费）至安全钱包
- 记录交易到 Supabase
- 转账成功或超时后退出应急状态

### 3. 数据库集成

- 使用 DatabaseExtension 统一管理数据
- 任务记录保存到 `scan_tasks` 表
- 交易记录保存到 `transactions` 表
- 延迟写入1分钟（避免阻塞）

### 4. API 接口

| 端点 | 方法 | 权限 | 说明 |
|------|------|------|------|
| `/health` | GET | 无 | 健康检查 |
| `/api/tasks` | GET | viewer+ | 获取任务列表 |
| `/api/tasks` | POST | admin | 创建任务 |
| `/api/task` | GET | viewer+ | 获取单个任务 |
| `/api/task` | PUT | admin | 更新任务 |
| `/api/scan` | GET | viewer+ | 扫描钱包 |
| `/api/transfer` | POST | admin | 手动转账 |
| `/api/auth/nonce` | GET | 无 | 生成 Nonce |
| `/api/auth/login` | POST | 无 | Web3 登录 |

## 目录结构

```
worker-2-scheduler/
├── src/
│   ├── index.js                  # 主入口（定时任务 + API 路由）
│   ├── lib/
│   │   ├── task-manager.js      # 任务管理器
│   │   ├── scanner.js           # 扫描器
│   │   ├── transfer.js          # 转账管理器
│   │   └── auth.js              # 认证管理器
│   └── api/                     # API 处理器（集成在 task-manager）
├── wrangler.toml                 # Worker 配置
├── package.json                  # 依赖配置（引用根目录）
└── README.md                    # 本文件
```

## 部署

### 环境变量配置

```bash
cd worker-2-scheduler

# 设置 Supabase 配置
wrangler secret put SUPABASE_URL
wrangler secret put SUPABASE_KEY
wrangler secret put JWT_SECRET

# 设置 BSC RPC
wrangler secret put BSC_RPC

# 设置代币地址
wrangler secret put TOKEN_WKEYDAO
wrangler secret put TOKEN_BNB

# 设置安全钱包
wrangler secret put SAFE_WALLET

# 设置钱包私钥
wrangler secret put WALLET_PRIVATE_KEY_0x钱包地址
```

### 部署命令

```bash
# 使用统一命令（在 cloudflare/ 根目录）
npm run deploy:w2

# 或直接部署
cd worker-2-scheduler
npm run deploy
```

## 使用示例

### 创建任务

```bash
curl -X POST https://your-worker.workers.dev/api/tasks \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "wallet_address": "0x...",
    "vortex_start_time": "2026-01-17T00:00:00Z"
  }'
```

### 查询任务列表

```bash
curl https://your-worker.workers.dev/api/tasks?wallet_address=0x... \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Web3 登录

```bash
# 1. 获取 Nonce
curl "https://your-worker.workers.dev/api/auth/nonce?address=0x..."

# 2. 签名并登录
curl -X POST https://your-worker.workers.dev/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "address": "0x...",
    "nonce": "...",
    "signature": "0x..."
  }'
```

## 与 Worker-1 的区别

| 特性 | Worker-1 | Worker-2 |
|------|-----------|-----------|
| 主要功能 | 抢先转移 | 定时任务 |
| 任务触发 | 检测到异常 | 用户创建 |
| 扫描频率 | 常规：每分钟；应急：5秒 | 常规：每分钟；应急：5秒 |
| 任务结束 | 应急状态结束 | 任务超时或转账成功 |
| 应急触发 | BNB新增或>0.001 | BNB新增、>0.001或wkeyDAO>0 |
| 数据库写入 | 立即写入 | 延迟1分钟 |

## 注意事项

1. **钱包验证**: 创建任务时验证钱包地址是否在保护列表中
2. **任务时间**: 扫描开始时间 = 涡轮开始 + 11.5小时（提前30分钟）
3. **任务超时**: 最大时间 = 涡轮结束 + 10分钟
4. **应急退出**: 应急状态最多持续10分钟，超时自动退出
5. **失败重试**: 转账失败后继续扫描，直到余额为0或超时

## 监控和日志

- Worker 日志: Cloudflare Dashboard → Workers → Logs
- 任务记录: Supabase `scan_tasks` 表
- 交易记录: Supabase `transactions` 表
- 错误日志: Supabase `errors` 表

---

**文档版本**: v2.0.0
**维护者**: X-plan 开发团队
