# 部署记录

**版本**: v2.4.0-dev
**日期**: 2026-02-01
**架构**: 扩展池架构（Extension Pool Architecture）

---

## 概述

本文档记录了 v2.4.0-dev 版本在两个 Cloudflare 账号上的部署情况。

---

## 账号1部署

### 基本信息

- **账号名称**: 3813518962@qq.com
- **Account ID**: `7d8c0fb0cc70cda866c1f942a543417c`
- **部署时间**: 2026-02-01
- **Worker URL**: https://worker-integrated-pool.3813518962.workers.dev
- **Version ID**: `f3bf39dc-99d6-42dc-b6a9-3f538085d445`

### KV命名空间

| 绑定名称 | 命名空间ID |
|---------|-----------|
| RPC_POOL | fa8ec69d4db14184a48e1012d4fa62c2 |

**注意**: EMERGENCY_STORE 已移除，使用 Supabase 作为持久化存储

### 环境变量配置

```toml
WORKER_ID = "worker-integrated-pool"
WORKER_NAME = "worker-integrated-pool"
PROTECTED_WALLETS = "0x9F4fba96e1D15f8547b9e41Be957Ff143C298e16,0x3D3914960567b3A253C429d5Ab81DA1F386F9111,0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89"
WALLET_SCAN_INTERVAL = "0"
BSC_RPC = "https://bsc-rpc.publicnode.com"
BSC_RPC_NODES = "https://bsc-rpc.publicnode.com,https://bsc-dataseed1.binance.org/,https://bsc-dataseed2.binance.org/,https://bsc-dataseed3.binance.org/,https://bsc-dataseed4.binance.org/,https://bsc-dataseed1.ninicoin.io/,https://bsc-dataseed2.ninicoin.io/,https://bsc-dataseed3.ninicoin.io/,https://bsc-dataseed1.defibit.io/,https://bsc-dataseed2.defibit.io/,https://bsc-dataseed3.defibit.io/"
BNB_THRESHOLD = "0.0005"
MAX_SCAN_DURATION = "7000"
COMPETITIVE_MODE = "true"
TOKEN_BNB = "0x0000000000000000000000000000000000000000"
TOKEN_WKEYDAO = "0x194B302a4b0a79795Fb68E2ADf1B8c9eC5ff8d1F"
TOKEN_USDT = "0x55d398326f99059fF775485246999027B3197955"
EMERGENCY_MAX_DURATION = "600"
EMERGENCY_SCAN_INTERVAL = "5"
MAX_TRANSFER_RETRIES = "3"
TARGET_BNB_BALANCE = "0.001"
SAFE_WALLET = "0xFB9Aa9240800cff881f735A09486322733c24050"
GAS_FUNDING_WALLET = "0xFB9Aa9240800cff881f735A09486322733c24050"
```

### Secrets配置

- `SUPABASE_URL`
- `SUPABASE_KEY`
- `WALLET_PRIVATE_KEY_0x9F4fba96e1D15f8547b9e41Be957Ff143C298e16`
- `WALLET_PRIVATE_KEY_0x3D3914960567b3A253C429d5Ab81DA1F386F9111`
- `WALLET_PRIVATE_KEY_0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89`
- `GAS_FUNDING_WALLET_PRIVATE_KEY`

### 部署命令

```bash
cd /workspace/cloudflare/worker-integrated-pool
export CLOUDFLARE_API_TOKEN="3r83Sa64WIxZHbPhD3rcjA8jTjGC5usY9nm5NyKY"
export CLOUDFLARE_ACCOUNT_ID="7d8c0fb0cc70cda866c1f942a543417c"
npx wrangler deploy
```

### 部署结果

✅ 部署成功
Cron触发器: `* * * * *` (每分钟执行)
Version ID: `f3bf39dc-99d6-42dc-b6a9-3f538085d445`

---

## 账号2部署

### 基本信息

- **账号名称**: Milaifon
- **Account ID**: `ef9cd986c28831a3f85041a8cf08990a`
- **部署时间**: 2026-02-01
- **Worker URL**: https://integrated-pool-2.2238642875.workers.dev
- **Version ID**: `b7e3b95b-8216-4fa8-9218-bf90b636f610`

### KV命名空间

| 绑定名称 | 命名空间ID |
|---------|-----------|
| RPC_POOL | 4a88f338254a462e92a1942415bb77a3 |

**注意**: EMERGENCY_STORE 已移除，使用 Supabase 作为持久化存储

### 环境变量配置

```toml
WORKER_ID = "integrated-pool-2"
WORKER_NAME = "integrated-pool-2"
PROTECTED_WALLETS = "0x9F4fba96e1D15f8547b9e41Be957Ff143C298e16,0x3D3914960567b3A253C429d5Ab81DA1F386F9111,0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89"
WALLET_SCAN_INTERVAL = "0"
BSC_RPC = "https://bsc-rpc.publicnode.com"
BSC_RPC_NODES = "https://bsc-rpc.publicnode.com,https://bsc-dataseed1.binance.org/,https://bsc-dataseed2.binance.org/,https://bsc-dataseed3.binance.org/,https://bsc-dataseed4.binance.org/,https://bsc-dataseed1.ninicoin.io/,https://bsc-dataseed2.ninicoin.io/,https://bsc-dataseed3.ninicoin.io/,https://bsc-dataseed1.defibit.io/,https://bsc-dataseed2.defibit.io/,https://bsc-dataseed3.defibit.io/"
BNB_THRESHOLD = "0.0005"
MAX_SCAN_DURATION = "7000"
COMPETITIVE_MODE = "true"
TOKEN_BNB = "0x0000000000000000000000000000000000000000"
TOKEN_WKEYDAO = "0x194B302a4b0a79795Fb68E2ADf1B8c9eC5ff8d1F"
TOKEN_USDT = "0x55d398326f99059fF775485246999027B3197955"
EMERGENCY_MAX_DURATION = "600"
EMERGENCY_SCAN_INTERVAL = "5"
MAX_TRANSFER_RETRIES = "3"
TARGET_BNB_BALANCE = "0.001"
SAFE_WALLET = "0xFB9Aa9240800cff881f735A09486322733c24050"
GAS_FUNDING_WALLET = "0xFB9Aa9240800cff881f735A09486322733c24050"
```

### Secrets配置

- `SUPABASE_URL`
- `SUPABASE_KEY`
- `WALLET_PRIVATE_KEY_0x9F4fba96e1D15f8547b9e41Be957Ff143C298e16`
- `WALLET_PRIVATE_KEY_0x3D3914960567b3A253C429d5Ab81DA1F386F9111`
- `WALLET_PRIVATE_KEY_0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89`
- `GAS_FUNDING_WALLET_PRIVATE_KEY`

### 部署命令

```bash
# 1. 退出旧账号（如已登录）
npx wrangler logout

# 2. 登录新账号
export CLOUDFLARE_API_TOKEN="-A5BBSpsG5CYt4_OHZGCZrtE9YpUYIBkfgo_P-Vq"
export CLOUDFLARE_ACCOUNT_ID="ef9cd986c28831a3f85041a8cf08990a"

# 3. 查询已存在的 KV 命名空间（如果已存在）
npx wrangler kv namespace list

# 4. 部署Worker（在 Worker 目录执行）
cd /workspace/cloudflare/integrated-pool-2
npx wrangler deploy src/index.js
```

### 部署结果

✅ 部署成功
Cron触发器: `* * * * *` (每分钟执行)
Version ID: `b7e3b95b-8216-4fa8-9218-bf90b636f610`

---

## 配置对比

| 配置项 | 账号1 | 账号2 | 说明 |
|-------|-------|-------|------|
| WORKER_ID | worker-integrated-pool | integrated-pool-2 | 用于区分不同部署 |
| WORKER_NAME | worker-integrated-pool | integrated-pool-2 | 用于区分不同部署 |
| PROTECTED_WALLETS | 相同 | 相同 | 被保护钱包地址 |
| TARGET_BNB_BALANCE | 0.001 | 0.001 | BNB目标余额 |
| COMPETITIVE_MODE | true | true | 竞争转账模式 |
| KV_RPC_POOL | fa8ec69d4db14184a48e1012d4fa62c2 | 4a88f338254a462e92a1942415bb77a3 | 节点池KV |

---

## 架构说明

### 扩展池架构特点

- **统一调度**: `worker-integrated-pool` 作为主调度器，每分钟执行一次
- **扩展函数**: emergency-worker、transfer-worker、aide-worker 作为扩展函数
- **同步调用**: 扩展函数同步调用，实现零延迟触发
- **分布式锁**: 每个扩展函数使用独立锁，避免冲突

### Worker职责

- **扫描器**: 扫描被保护钱包的余额和代币数量
- **应急状态扩展**: 当余额低于阈值时，进入应急状态并频繁扫描
- **转账扩展**: 执行转账操作，转出所有资产到安全钱包
- **辅助扩展**: 转账后的辅助操作（如记录日志、通知等）

---

## 常见操作

### 查看日志

```bash
# 账号1
cd /workspace/cloudflare/worker-integrated-pool
export CLOUDFLARE_API_TOKEN="3r83Sa64WIxZHbPhD3rcjA8jTjGC5usY9nm5NyKY"
export CLOUDFLARE_ACCOUNT_ID="7d8c0fb0cc70cda866c1f942a543417c"
npx wrangler tail

# 账号2（需先登录对应账号）
cd /workspace/cloudflare/integrated-pool-2
export CLOUDFLARE_API_TOKEN="-A5BBSpsG5CYt4_OHZGCZrtE9YpUYIBkfgo_P-Vq"
export CLOUDFLARE_ACCOUNT_ID="ef9cd986c28831a3f85041a8cf08990a"
npx wrangler tail
```

### 更新部署

```bash
# 修改代码后执行
cd /workspace/cloudflare/worker-integrated-pool
npx wrangler deploy
```

### 切换账号

```bash
# 退出当前账号
npx wrangler logout

# 设置新账号的环境变量
export CLOUDFLARE_API_TOKEN="your-new-api-token"
export CLOUDFLARE_ACCOUNT_ID="your-new-account-id"

# 验证登录
npx wrangler whoami
```

---

## 注意事项

1. **KV命名空间**: 每个账号使用独立的 KV 命名空间
2. **Secrets配置**: 需要在 Cloudflare 控制台手动配置 Secrets
3. **账号切换**: 部署到不同账号时，需要切换环境变量
4. **代码一致性**: 两个账号使用相同的代码，但配置不同
5. **部署目录**: 部署时需要在 Worker 子目录执行命令
6. **EMERGENCY_STORE 移除**: v2.4.0 版本已移除 EMERGENCY_STORE，使用 Supabase 作为持久化存储

---

**最后更新**: 2026-02-01
