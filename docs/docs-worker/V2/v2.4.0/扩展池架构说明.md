# v2.4.0 扩展池架构说明

## 概述

v2.4.0 版本采用**扩展池架构**（Extension Pool Architecture），将应急状态、转账、Aide等功能实现为可复用的扩展函数，由 `worker-bot-scan` 统一调度同步调用，实现零延迟触发。

---

## 核心设计理念

### 问题背景

**旧架构的延迟问题**：

```
T0: Scan 发现触发条件 (0s)
  ↓ KV队列写入
T1: Emergency Cron触发 (60s后)
  ↓ KV队列写入
T2: Transfer Cron触发 (60s后)
  ↓ KV队列写入
T3: Aide Cron触发 (60s后)

总延迟: ~180秒 (3分钟)
```

**问题**：
- 应急状态失去意义（3分钟延迟）
- KV队列读写开销大
- Worker资源浪费（大部分时间空闲）

---

### 解决方案：扩展池架构

**新架构的数据流**：

```
T0: Scan 发现触发条件 (0s)
  ↓ 同步调用扩展函数
T1: Emergency/Transfer 执行 (几秒内)
  ↓ 同步调用扩展函数
T2: Aide 监控 (几秒内)

总延迟: ~几秒
```

**核心优势**：
- ✅ **零延迟触发**：从扫描发现到执行，无中间Cron间隔
- ✅ **资源高效利用**：扩展函数按需调用，避免空闲Worker
- ✅ **易于扩展**：新功能可添加为新的扩展函数
- ✅ **调试简化**：所有逻辑在同一Worker中，日志和追踪更清晰

---

## 架构设计

### 1. 扩展函数定义

#### EmergencyWorkerExtension（应急状态扩展）

```javascript
// 创建应急扩展实例
const emergencyWorker = createEmergencyWorkerExtension(env, {
  bnbThreshold: '0.0005',
  maxDuration: 600,      // 10分钟
  scanInterval: 5,       // 5秒扫描一次
  tokenWkeyDao: '0x...',
  tokenUsdt: '0x...'
})

// 运行应急循环
const result = await emergencyWorker.runEmergencyLoop(
  walletAddress,
  rpcUrl,
  checkLockCallback  // 锁有效性检查回调
)
```

**功能**：
- 执行应急循环（5秒扫描一次，最多10分钟）
- 只扫描命中钱包，提高效率
- 检测到代币后触发transfer扩展
- 支持锁有效期检查

---

#### TransferWorkerExtension（转账扩展）

```javascript
// 创建转账扩展实例
const transferWorker = createTransferWorkerExtension(env, {
  maxRetries: 3,
  safeWallet: '0x...',
  tokenWkeyDao: '0x...',
  tokenUsdt: '0x...'
})

// 运行转账循环
const result = await transferWorker.runTransferLoop(
  walletAddress,
  tokenType,  // 'wkeydao' | 'usdt'
  db,
  rpcUrl,
  lock
)

// result.aideTasks 包含需要监控的交易列表
```

**功能**：
- 执行转账循环（无时限，钱包清空即退出）
- 3次失败才补充Gas
- 返回 aideTasks（待监控的交易列表）
- 支持Gas补充

---

#### AideWorkerExtension（Aide扩展）

```javascript
// 创建Aide扩展实例
const aideWorker = createAideWorkerExtension(env, {
  txCheckInterval: 5,    // 5秒检查一次
  maxTxWaitTime: 600,    // 最多等待10分钟
  maxTxRetries: 10
})

// 监控交易
const result = await aideWorker.monitorTransactions(
  aideTasks,  // 交易列表
  rpcUrl,
  db
)
```

**功能**：
- 监控交易状态（成功/失败/待确认）
- 更新Supabase数据库
- 失败时创建重试任务或Gas补充任务

---

### 2. 统一调度器（worker-bot-scan）

```javascript
// 扫描钱包
const result = await scanWallet(env, wallet, rpcPool, db)

if (result.success) {
  if (result.action.action === 'emergency') {
    // 同步调用应急状态扩展
    const emergencyResult = await executeEmergency(env, wallet, rpcUrl, lock)

    // 如果应急状态触发了转账，继续处理
    if (emergencyResult.transferTriggered) {
      const transferResult = await executeTransfer(env, wallet, tokenType, db, rpcUrl, lock)
      await executeAide(env, transferResult.aideTasks, rpcUrl, db)
    }
  } else if (result.action.action === 'transfer') {
    // 同步调用转账扩展
    const transferResult = await executeTransfer(env, wallet, tokenType, db, rpcUrl, lock)

    // 转账成功，调用Aide监控交易
    if (transferResult.success && transferResult.aideTasks) {
      await executeAide(env, transferResult.aideTasks, rpcUrl, db)
    }
  }
}
```

**关键点**：
- 所有扩展函数同步调用，无中间延迟
- 扩展函数返回需要传递给下一个扩展的数据（如 aideTasks）
- 锁机制确保并发安全

---

## 扩展函数特点

### 1. 独立性

- 每个扩展函数是一个独立的模块
- 可单独测试和调试
- 可复用到其他Worker

### 2. 可组合性

- 扩展函数可以按需组合调用
- 可以在不同的场景下调用（如手动触发、测试等）

### 3. 状态传递

- 扩展函数通过返回值传递状态（如 aideTasks）
- 支持链式调用（Emergency → Transfer → Aide）

### 4. 锁机制

- 每个扩展函数独立管理锁
- 支持锁超时和释放
- 支持锁有效性检查（通过回调函数）

---

## 配置示例

### worker-bot-scan wrangler.toml

```toml
[vars]
WORKER_ID = "worker-bot-scan"
PROTECTED_WALLETS = "0x...,0x...,0x..."
WALLET_SCAN_INTERVAL = "0"

# 应急状态配置
EMERGENCY_MAX_DURATION = "600"
EMERGENCY_SCAN_INTERVAL = "5"
BNB_THRESHOLD = "0.0005"

# 转账配置
MAX_TRANSFER_RETRIES = "3"
TARGET_BNB_BALANCE = "0.002"

# 代币配置
TOKEN_WKEYDAO = "0x194B302a4b0a79795Fb68E2ADf1B8c9eC5ff8d1F"
TOKEN_USDT = "0x55d398326f99059fF775485246999027B3197955"
SAFE_WALLET = "0x..."
GAS_FUNDING_WALLET = "0x..."
```

---

## 部署说明

### 主要部署：worker-bot-scan

```bash
cd /workspace/cloudflare/worker-bot-scan

# 配置Secrets
wrangler secret put SUPABASE_URL
wrangler secret put SUPABASE_KEY
wrangler secret put WALLET_PRIVATE_KEY_0x9F4fba96e1D15f8547b9e41Be957Ff143C298e16
wrangler secret put WALLET_PRIVATE_KEY_0x3D3914960567b3A253C429d5Ab81DA1F386F9111
wrangler secret put WALLET_PRIVATE_KEY_0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89
wrangler secret put GAS_FUNDING_WALLET
wrangler secret put GAS_FUNDING_WALLET_PRIVATE_KEY

# 部署
npx wrangler deploy
```

### 可选部署：其他worker-bot（仅用于测试）

worker-bot-emergency、worker-bot-transfer、worker-bot-aide的Cron触发器已禁用，仅保留HTTP端点用于测试和调试。

```bash
# 手动触发应急状态（测试）
curl -X POST -H "Content-Type: application/json" \
  -d '{"walletAddress":"0x...","reason":"manual_test"}' \
  https://worker-bot-emergency.workers.dev

# 手动触发转账（测试）
curl -X POST -H "Content-Type: application/json" \
  -d '{"walletAddress":"0x...","tokenType":"wkeydao"}' \
  https://worker-bot-transfer.workers.dev

# 查询交易状态（测试）
curl https://worker-bot-aide.workers.dev?txHash=0x...
```

---

## 扩展池的优势

### 1. 性能优势

| 指标 | 旧架构 | 新架构 | 提升 |
|------|--------|--------|------|
| 应急响应延迟 | ~180秒 | ~几秒 | **30倍** |
| KV队列读写 | 频繁 | 最小化 | **减少90%** |
| Worker资源占用 | 4个Worker | 1个活跃Worker | **减少75%** |

### 2. 开发效率

- 新功能只需创建新的扩展函数，无需新建Worker
- 所有逻辑在同一个Worker中，调试更简单
- 扩展函数可单独测试和复用

### 3. 运维效率

- 只需监控一个主要Worker（worker-bot-scan）
- 减少配置和部署的复杂度
- 降低失败点（减少Worker数量）

---

## 未来扩展

### 可添加的扩展函数

1. **AlertWorkerExtension**：告警扩展，在特定条件下发送通知
2. **AnalyticsWorkerExtension**：分析扩展，统计钱包活动和转账数据
3. **RebalancingWorkerExtension**：再平衡扩展，自动调整钱包配置

### 可组合的工作流

```
Scan → Emergency → Transfer → Aide → Alert
Scan → Analytics
Scan → Rebalancing
```

---

## 注意事项

1. **扩展函数执行时间**：确保扩展函数不会阻塞Scan的主要扫描逻辑太长时间
2. **错误处理**：每个扩展函数应独立处理错误，不影响其他扩展函数
3. **资源限制**：注意Cloudflare Workers的CPU时间限制（10秒免费，最多30秒）
4. **并发控制**：使用锁机制确保并发安全

---

**文档创建日期**：2026-01-31
**版本**：v2.4.0-dev
**作者**：X-plan Team
