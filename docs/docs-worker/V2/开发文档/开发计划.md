# Cloudflare Workers 开发计划

## 项目重构说明

本项目进行架构重构，将Cloudflare Workers相关代码统一迁移到 `cloudflare/` 目录下，采用统一的扩展架构管理共享功能。

## 目录结构

```
cloudflare/
├── extensions/           # 共享扩展模块
│   └── rpc-pool/        # RPC节点池扩展
├── worker1/             # Worker 1（主业务Worker）
├── worker2/             # Worker 2（计划中）
├── worker3/             # Worker 3（计划中）
└── docs/                # 文档
```

---

## RPC Pool 扩展

### 目标
实现BSC RPC节点的智能轮换和优化，避免单节点高频访问被标记为黑名单。

### 核心功能

#### 1. 节点池管理
- 维护BSC公共节点列表（官方节点 + PublicNode）
- 支持运行时动态添加/移除节点
- 提供节点列表查询接口

#### 2. 智能轮换策略
- **简单优化机制**：失败节点自动移至队尾
- **自动筛选**：通过N次轮询，性能差的节点自然排在后面
- **人工管理**：查看节点列表，手动删除差节点
- **返回最优节点**：`getBestRpc()` 返回前5个节点

#### 3. 超时与重试
- 单次握手超时：7秒
- 失败后立即切换到下一个节点
- 异步模式最大重试5次
- 全部失败后抛出异常，终止当前任务

#### 4. 接口设计

```javascript
class RpcPoolExtension {
  // 初始化节点池
  constructor(env)

  // 获取前5个最优节点
  async getBestRpc()

  // 添加节点
  async addNode(nodeUrl)

  // 移除节点
  async removeNode(nodeUrl)

  // 获取节点列表（排序后的完整列表）
  async getNodeList()

  // 导出配置
  exportConfig()

  // 导入配置
  importConfig(config)
}
```

#### 5. 使用方式（工厂模式）

```javascript
import { RpcPoolExtension } from '../../extensions/rpc-pool/index.js'

class Scanner {
  constructor(env) {
    this.rpcPool = new RpcPoolExtension(env)
  }

  async scan(walletAddress) {
    try {
      // 获取最优节点
      const bestNodes = await this.rpcPool.getBestRpc()

      // 尝试连接（最多5次）
      for (let i = 0; i < bestNodes.length; i++) {
        try {
          const provider = new ethers.JsonRpcProvider(bestNodes[i])
          // 执行业务逻辑...
          return result
        } catch (error) {
          // 超时错误，节点自动移到队尾
          if (i === bestNodes.length - 1) {
            throw new Error('所有节点均不可用')
          }
        }
      }
    } catch (error) {
      console.error('扫描失败:', error)
      throw error
    }
  }
}
```

### 节点列表（默认配置）

```javascript
const DEFAULT_NODES = [
  // PublicNode
  'https://bsc-rpc.publicnode.com',

  // 官方节点
  'https://bsc-dataseed1.binance.org/',
  'https://bsc-dataseed2.binance.org/',
  'https://bsc-dataseed3.binance.org/',
  'https://bsc-dataseed4.binance.org/',
  'https://bsc-dataseed1.ninicoin.io/',
  'https://bsc-dataseed2.ninicoin.io/',
  'https://bsc-dataseed3.ninicoin.io/',
  'https://bsc-dataseed1.defibit.io/',
  'https://bsc-dataseed2.defibit.io/',
  'https://bsc-dataseed3.defibit.io/'
]
```

### 实现细节

#### 排序规则
- **初始顺序**：按配置文件中的顺序
- **失败处理**：节点连接超时（7秒），自动移到队尾
- **无需统计**：不记录响应时间、成功率等复杂指标
- **优胜劣汰**：通过多次轮询，性能差的节点自然沉淀在队尾

#### 超时控制
- 统一超时时间：7秒
- 超时定义：无法在7秒内创建WebSocket/HTTP连接
- 超时处理：立即切换到下一个节点

#### 重试逻辑
- 异步模式（Promise.all）：最多重试5次（前5个节点）
- 单步模式：最多重试3次
- 全部失败：抛出异常，终止当前任务

#### 配置管理
- 仅存储节点URL（无需权重、优先级等额外信息）
- 支持环境变量配置：`env.BSC_RPC_NODES`（逗号分隔）
- 支持运行时动态添加/移除节点
- 预留数据中台对接接口

### 待集成项目

#### guard-plus-worker
- 文件路径：`guard-plus/guard-plus-worker/src/lib/scanner.js`
- 当前超时：3000ms → 改为7000ms
- 集成方式：创建RpcPoolExtension实例，替换单一RPC节点

#### cloudflare-worker
- 文件路径：`cloudflare-worker/src/` (多个scanner文件)
- **注意**：暂不改造，需先获得授权
- 计划集成：待授权后统一改造

### 数据中台接口预留

未来数据中台可提供：
- 节点实时状态监控
- 自动化节点健康管理
- 节点性能分析报表
- 智能节点推荐

---

## 计划中的Workers

### Worker 1: Guard Plus Worker
- **状态**：已部署
- **功能**：wkeyDAO代币防盗监控
- **路径**：待从 `guard-plus/guard-plus-worker/` 迁移到 `cloudflare/worker1/`

### Worker 2: （待定义）
- **状态**：计划中
- **功能**：待规划

### Worker 3: （待定义）
- **状态**：计划中
- **功能**：待规划

---

## 其他扩展模块

### extensions/ 目录规划
- `rpc-pool/` - RPC节点池扩展（当前开发）
- 其他扩展模块待规划...

---

## 开发进度

### RPC Pool 扩展
- [x] 需求分析与设计
- [ ] 核心代码实现
- [ ] 单元测试
- [ ] 集成到guard-plus-worker
- [ ] 文档完善

### 项目重构
- [ ] 创建cloudflare/目录结构
- [ ] 迁移guard-plus-worker到cloudflare/worker1/
- [ ] 更新部署脚本
- [ ] 更新文档

---

## 注意事项

1. **cloudflare-worker/ 目录**：独立部署的Worker，暂不修改
2. **guard-plus/ 目录**：主项目，计划迁移到新的cloudflare/结构
3. **权限管理**：修改cloudflare-worker/前需获得用户授权并立即commit

---

## 参考资料

- [BSC RPC节点高频访问保护策略](../../docs/BSC_RPC节点高频访问保护策略.md)
- [Cloudflare Workers官方文档](https://developers.cloudflare.com/workers/)
