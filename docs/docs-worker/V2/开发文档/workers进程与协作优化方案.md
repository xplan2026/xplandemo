# Cloudflare Worker 进程与协作优化方案

## 一、分析[盗币流程]，并清晰每个worker的职责
- step1. 从`盗币者`钱包向三个`被保护钱包`中某一个转入`BNB`
    - 已知`盗币者钱包`地址2个，有可能增加或更换
    - 盗币者钱包一：`0x4A01eFCdA6d077A8AF6555Aa83Bc11E7be093561`
    - 盗币者钱包二：`0xF95B911a3d26b076a10aC726Fde5D800972104B4`
    - [worker-3]的职责就是监视`盗币者钱包`，
        - 如果其向`被保护者钱包`转入`BNB`
            - 卡点1：如何查询交易记录现在是个问题，注意这是不是查余额，是查已过去的一分钟是否有向`被保护钱包`转帐的交易记录，需要的接口命令不一样（不知是否有不用`API Token`查询交易记录的接口）
                - 逻辑是：`盗币者钱包`在过去的一分钟的交易记录中，是否包含记录 [to: `被保护钱包中`的任一个]
                - *关于查询交易记录的解决方案，请参见《讨论使用Infura查询交易记录》，请结合我们当前的项目架构给出是否可行的结论*
            - `BSCScan`的`API Token`政策改为了`Eth v2`，会产生费用，
            - 是否有其它可用的免费平台接口？
        - 触发接收`BNB`的`被保护钱包`进入`应急状态`(注意，这是我们优化的点之一，只有一个`被保护钱包`被触发)
    
    
- stpe2. 主动执行`wkeyDAO`代币`涡轮`结束（前提是`涡轮`时长接近12小时，这一步需要`gas`费，所以盗币者首先要执行第一步）
    - [worker-2]的职责描述：
        - 创建一个前端页面，可以通过表单：
            - 选择一个被保护地址
            - 输入涡轮开始的时间
            - 点击“创建任务”按钮，他建一个倒计时任务，在涡轮结束前30分钟触发进入应急状态，任务结束。
            - 触发即任务结束，其它进程的调用与此任务无关
            - 可以前端查看/删除已创建的任务
            - 可以查看已执行任务（成功/失败，通过Supabase查询）
    - [worker-4]的职责就是监视`涡轮`结束后向`被保护钱包`发送`wkeyDAO`代币的`合约地址`
        - 涡轮合约地址：`0xa8aCdd81F46633b69AcB6ec5c16Ee7E00cc8938D`
        - 查询交易记录的实现请依据之前的结论
        - 如果返回true，则有转入记录的被保护钱包进入应急状态
        - worker-4只负责返回true以触发，其它进程与之无关

- step3. 等待`wkeyDAO`代币进入当前操作的`被保护钱包`（也就是第一步时接收`BNB`的钱包）
    - [worker-1]的职责描述：
        - 每分钟扫描一次被保护钱包的所有代币余额（BNB和wkeyDAO）
        - 如果BNB有增加（有增加或是BNB余额>0，这个设计仍然是需要讨论的，*worker-1与其它3个协同worker的不同之处是直接触发转帐，而不是进入应急状态。importend!*），或wkeyDAO余额>0，直接触发转帐操作
        - 当前设计与原代码不符，需修改。特别是转帐操作独立出去。


- step4. 盗币者将到帐的`wkeyDAO`代币及扣除`gas`费之后剩余的`BNB`转移至盗币者钱包
---

## 二、优化思路

### 2.1 职责分拆，进程优化
这个设计的思路是包括worker独立的`scanner.js`在内的所有`scanner.js`只负责扫描和返回结果，不参与其它任务进程，保障扫描状态不中断，减少阻塞和系统处理错误的开销，具体的优化结论需要你给出。

#### 全局`scanner.js`

1. 全局`scanner.js`的逻辑分析与流程设计
    - 根据[盗币流程]的分析和对4个worker的职责定义，你可以把它想像成一个四冲程发动机的点火设计，一分钟内完成一个冲程（轮流调动4个worker的独立scanner.js工作，每分钟重复一次）
    - 全局`scanner.js`负责调度4个worker的独立`scanner.js`（有执行顺序）
    - 出现错误的处理机制
    - 你认为需要的设计    

#### 4个worker独立的`scanner.js`

1. 4个worker独立`scanner.js`的扫描对象及职责界定

- `worker-1`的`scnaner-1.js`: 
    - 扫描对象：3个`被保护钱包`地址中的余额
    - 负责每分钟对3个`被保护钱包`轮流扫描（不能同时执行3个地址的扫描，原因在之前开发文档中有记录）
    - 只返回两种代币的余额值，不做计算；把计算和判断交给触发器；

- `worker-2`的`scanner-2.js`:
    - `worker-2`的特殊：是由用户在前端创建定时任务（该工作原理见前章节[worker-2]职责描述）
    - 扫描对象：只扫描3个`被保护钱包`中的`wkeyDAO`的余额是否>0
    - 返回true，触发器工作（进入`应急状态`），后续进程与`scanner-2.js`无关
    - 它不是固定每天的每分钟执行查询，是在用户通过前端创建任务后，按设定的时间开始执行，返回`true`或达到最长时间终止任务
    
- `worker-3`的`scanner-3.js`:
    - 理论上不应该叫扫描，应该是查询。查询`盗币者钱包`之前一分钟是否有向3个`被保护钱包`任一地址转入`BNB`的记录
    - 查询功能的实现目前还没有结果，本文其它地方有单独讨论
    - 返回`true`，`触发器`工作（进入`应急状态`），后续进程与`scanner-3.js`无关

- `worker-4`的`scanner-4.js`:
    - 扫描对象：仍然是查询。查询`wkeyDAO`的`涡轮`合约地址在一分钟内是否有向`被保护钱包`转帐的记录
    - 返回`true`，`触发器`工作（进入`应急状态`），后续进程与`scanner-4.js`无关

- 原代码中按`被保护钱包`末尾4位命名的scannerXXXX.js是否保留由你决定，但需经过我们的讨论

#### 统一的`应急状态`

`应急状态`的功能、逻辑和进程无太大变化，但是把之前代码中各个worker的`应急状态`合并，如果其中有不相同的逻辑，我们讨论至统一。

接收到任意一个触发，即可转入`应急状态`，但因为给出触发的来源多样，所以改造的重点应放在`分布式锁`的设计上，可能会增加逻辑判断。

这也是优化的重点之一，可以极大的减少系统开销（特别是在判断执行上，不需要每次扫描都执行）；优化程度你可以给出分析数据。

#### 独立的`transfer.js`

- 只执行命中目标的转帐功能
- 两种触发转帐的情况：
    - 由应急状态发出的转帐通知
    - 由`worker-1`发出的转帐通知
- `wkeyDAO`优先转移，扣除`Gas`费之后的`BNB`优先级排第二
- 独立执行，与其它所有进程的判断/计算无关，极大减少开销

#### 独立的交易结果记录者

- 我把它命名为`aide.js`，
- 是做为整个工作流程独立的观察者和记录者
- 职责分离，减少`transfer.js`的开销

是否提高性能，请给出结论

### 2.2 全局`scanner.js`的调用顺序

我们根据[盗币流程]来设计全局`scanner.js`对每个worker的`scanner.js`的调用顺序。
顺应了这个时间线，可以克服由于`cloudflare-worker`对于最小一分钟执行一次定时任务的限制，提升安全性。

重点：每个调用的worker的scanner都是独立进程，要在获得返回后及时释放，特别是查询任务；以免造成下一次调用的阻塞。

#### 具体的调用顺序：

- [worker-3]
- [worker-2]
    - 这里特殊，前提是用户创建了`定时任务`，
    - 并且是达到了任务开始的时间，它会直接触发`应急状态`
    - 如果没有任务可忽略
- [worker-1]
    - 这与[盗币流程]中的顺序不同，因为它是扫描，返回结果的速度高于[worker-4]，[woker-4]在本框架设计中，是做为一个辅助措施。
- [worker-4]
---

## 三、风险

### 根据`Cloudflare`最新官方文档，其免费套餐对Worker的CPU执行时间有更严格的“动态限制”，而非固定的每日总额：

- 限制标准：每个请求的CPU时间不得超过 10毫秒 或 30毫秒（取决于账户类型和区域）。超过此限制，请求会被立即终止。我们设计的交易等待最大20秒的策略是否受此影响？
- 在付费套餐（$5/月起）中，才有每日总计的CPU时间配额（如5万毫秒）。
- 这意味着，对于免费套餐，我们是否面临风险：[单次请求CPU时间过长]导致执行失败。
---

**标记**：v4.0.0商用版中增加一个功能：记录日志或发送通知（如Telegram、短信），告知用户应急操作已执行。