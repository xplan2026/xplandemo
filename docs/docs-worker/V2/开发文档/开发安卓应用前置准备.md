# 开发安卓应用前置准备

**创建日期**: 2026-01-23
**版本**: v1.0.0

---

## 一、开发环境准备

### 1.1 安装 Android Studio

**要求**:
- Android Studio Koala (2024.1.1) 或更新版本
- 包含 Android SDK、模拟器、构建工具

**安装步骤**:
1. 下载 Android Studio: https://developer.android.com/studio
2. 运行安装程序，按提示完成安装
3. 首次启动时，安装推荐组件

### 1.2 安装 JDK

**要求**:
- JDK 17 或 JDK 21
- 推荐使用 Android Studio 内置的 JDK

**配置步骤**:
```bash
# 检查 JDK 版本
java -version

# 设置 JAVA_HOME 环境变量（可选）
export JAVA_HOME=/path/to/jdk
export PATH=$PATH:$JAVA_HOME/bin
```

### 1.3 配置 Android SDK

**必需的 SDK 组件**:
- Android SDK Platform-Tools (最新版)
- Android SDK Build-Tools (推荐 34.0.0)
- Android 14.0 (API 34) 或更新版本的 SDK Platform
- 至少一个系统镜像（用于模拟器，如 Pixel 5 API 34）

**安装方法**:
1. 打开 Android Studio → Tools → SDK Manager
2. 在 SDK Platforms 标签页中勾选 Android 14.0
3. 在 SDK Tools 标签页中勾选必需组件
4. 点击 Apply 安装

---

## 二、测试设备准备

### 2.1 真机测试（推荐）

**设备要求**:
- Android 7.0 (API 24) 或更高版本
- 至少 2GB RAM
- 支持开发者选项

**设置步骤**:
1. 打开手机的"设置" → "关于手机"
2. 连续点击"版本号" 7 次启用开发者选项
3. 返回"设置" → "系统和更新" → "开发者选项"
4. 开启"USB 调试"
5. 使用 USB 数据线连接电脑
6. 手机端授权 USB 调试

**验证连接**:
```bash
adb devices
# 应显示已连接的设备
```

### 2.2 模拟器测试（备选）

**创建 AVD (Android Virtual Device)**:
1. 打开 Android Studio → Tools → AVD Manager
2. 点击 Create Virtual Device
3. 选择设备型号（推荐 Pixel 5）
4. 选择系统镜像（推荐 API 34）
5. 完成创建

**注意**: 模拟器无法获取真实手机号，需要手动输入测试号码。

### 2.3 手机号获取（鉴权功能）

**本机号获取方式**:

| Android 版本 | 获取方式 |
|-------------|---------|
| Android 10- | 自动读取 `TelephonyManager.line1Number` |
| Android 10+ | 需要用户手动输入 |

**开发配置**:
在开发阶段，将开发者的真实手机号配置到 `AppPreferences.bindPhoneNumber` 中，用于鉴权验证。

---

## 三、网络和 RPC 准备

### 3.1 BSC RPC 节点

**免费节点**:
- `https://bsc-rpc.publicnode.com`
- `https://bsc-dataseed.binance.org`
- `https://bsc-dataseed1.defibit.io`

**付费节点**（推荐用于生产环境）:
- Ankr: https://www.ankr.com/rpc/bsc
- QuickNode: https://www.quicknode.com/chains/bsc

**配置方式**:
将 RPC URL 配置到 `AppPreferences.bscRpcUrl`

### 3.2 Cloudflare KV 配置

**前提条件**:
- 已有 Cloudflare 账户
- 已创建 KV Namespace（例如 `EMERGENCY_STORE`）

**KV 绑定配置**:
在 `/workspace/cloudflare/worker-1-interception/wrangler.toml` 中添加：
```toml
[[kv_namespaces]]
binding = "EMERGENCY_STORE"
id = "your_kv_namespace_id"
```

**获取 KV Namespace ID**:
```bash
npx wrangler kv:namespace list
```

---

## 四、开发账户准备

### 4.1 Cloudflare Workers 账户

**必需条件**:
- Cloudflare 账户
- Worker API Key（用于 Android App 调用 KV API）

**API Key 配置**:
```bash
# 查看或创建 API Token
# 访问: https://dash.cloudflare.com/profile/api-tokens
```

### 4.2 Cloudflare Worker API 扩展

**需要在 Worker-1 中添加的 API 端点**:

| 端点 | 方法 | 说明 |
|-----|------|------|
| `/api/kv/put` | POST | 写入 KV 值（获取锁） |
| `/api/kv/get` | GET | 读取 KV 值（检查锁） |
| `/api/kv/delete` | DELETE | 删除 KV 值（释放锁） |

**实现细节**（参考 `Worker-2安卓应用设计方案.md` 第九章）。

---

## 五、项目初始化准备

### 5.1 创建 Android 项目

**项目配置**:
- Name: `BSC Guard`
- Package name: `com.bscguard`
- Language: Kotlin
- Minimum SDK: API 24 (Android 7.0)
- Build configuration: Kotlin DSL

### 5.2 Gradle 依赖配置

**项目根目录 `build.gradle.kts`**:
```kotlin
plugins {
    id("com.android.application") version "8.2.0" apply false
    id("org.jetbrains.kotlin.android") version "1.9.20" apply false
    id("com.google.dagger.hilt.android") version "2.48.1" apply false
}
```

**App 模块 `build.gradle.kts`**:
```kotlin
dependencies {
    // Kotlin Coroutines
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3")

    // Jetpack Compose
    implementation(platform("androidx.compose:compose-bom:2023.10.01"))
    implementation("androidx.compose.ui:ui")
    implementation("androidx.compose.material3:material3")
    implementation("androidx.activity:activity-compose:1.8.1")
    implementation("androidx.navigation:navigation-compose:2.7.6")

    // Lifecycle
    implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.6.2")
    implementation("androidx.lifecycle:lifecycle-runtime-compose:2.6.2")
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.6.2")

    // Room Database
    implementation("androidx.room:room-runtime:2.6.1")
    implementation("androidx.room:room-ktx:2.6.1")
    kapt("androidx.room:room-compiler:2.6.1")

    // Hilt Dependency Injection
    implementation("com.google.dagger:hilt-android:2.48.1")
    kapt("com.google.dagger:hilt-compiler:2.48.1")
    implementation("androidx.hilt:hilt-navigation-compose:1.1.0")

    // Web3j (BSC 交互)
    implementation("org.web3j:core:4.10.0")

    // OkHttp (网络请求)
    implementation("com.squareup.okhttp3:okhttp:4.12.0")
    implementation("com.squareup.okhttp3:logging-interceptor:4.12.0")

    // Date Picker
    implementation("io.github.vanpra.compose-material-dialogs:datetime:0.9.0")

    // JSON 解析
    implementation("org.jetbrains.kotlinx:kotlinx-serialization-json:1.6.0")
}
```

### 5.3 项目目录结构

按照设计方案创建目录结构：
```
app/src/main/java/com/bscguard/
├── MainActivity.kt
├── BscGuardApp.kt
├── domain/
├── data/
├── presentation/
├── core/
└── di/
```

---

## 六、代码迁移/扩展准备

### 6.1 Worker-1 API 扩展

**文件**: `/workspace/cloudflare/worker-1-interception/src/index.js`

**需要添加的代码**:
```javascript
// KV 操作 API（仅供 Android App 调用）

// PUT /api/kv/put - 写入 KV（获取锁）
if (url.pathname === '/api/kv/put' && request.method === 'POST') {
    const { key, value, expirationTtl } = await request.json();
    await env.EMERGENCY_STORE.put(key, value, {
        expirationTtl: expirationTtl
    });
    return new Response(JSON.stringify({ success: true }), {
        headers: { 'Content-Type': 'application/json' }
    });
}

// GET /api/kv/get - 读取 KV（检查锁）
if (url.pathname === '/api/kv/get' && request.method === 'GET') {
    const key = url.searchParams.get('key');
    const value = await env.EMERGENCY_STORE.get(key);
    return new Response(JSON.stringify({ value }), {
        headers: { 'Content-Type': 'application/json' }
    });
}

// DELETE /api/kv/delete - 删除 KV（释放锁）
if (url.pathname === '/api/kv/delete' && request.method === 'DELETE') {
    const key = url.searchParams.get('key');
    await env.EMERGENCY_STORE.delete(key);
    return new Response(JSON.stringify({ success: true }), {
        headers: { 'Content-Type': 'application/json' }
    });
}
```

### 6.2 其他 Workers 锁检查

**Worker-3、Worker-4 需要添加锁检查逻辑**:

```javascript
// 检查分布式锁状态
async function isSchedulerActive(env) {
    const lockValue = await env.EMERGENCY_STORE.get('scheduler_active');
    return lockValue !== null && lockValue !== '';
}

// 在 scheduled 函数中使用
export default {
    async scheduled(event, env, ctx) {
        // 检查 Android App 是否在工作
        const schedulerActive = await isSchedulerActive(env);
        if (schedulerActive) {
            logger.info('Scheduler is active, skipping execution');
            return;
        }

        // 正常执行扫描
        // ...
    }
}
```

---

## 七、权限和配置准备

### 7.1 Android 权限配置

**文件**: `app/src/main/AndroidManifest.xml`

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android">

    <!-- 网络权限 -->
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <!-- 前台服务权限 -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />

    <!-- 手机号权限（仅 Android 10-） -->
    <uses-permission android:name="android.permission.READ_PHONE_NUMBERS"
                      android:maxSdkVersion="29" />
    <uses-permission android:name="android.permission.READ_PHONE_STATE"
                      android:maxSdkVersion="29" />

    <!-- 通知权限（Android 13+） -->
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

    <application>
        <!-- 应用配置 -->
    </application>
</manifest>
```

### 7.2 应用签名配置

**调试签名**（开发阶段自动生成）:
- Android Studio 自动生成 `debug.keystore`
- 位置: `~/.android/debug.keystore`

**发布签名**（生产环境）:
```bash
# 生成密钥库
keytool -genkey -v -keystore release.keystore -alias bsc_guard -keyalg RSA -keysize 2048 -validity 10000

# 配置到 build.gradle.kts
signingConfigs {
    create("release") {
        storeFile = file("release.keystore")
        storePassword = "your_store_password"
        keyAlias = "bsc_guard"
        keyPassword = "your_key_password"
    }
}
```

---

## 八、当前 Workspace 环境检查

### 8.1 已具备的条件

| 条件 | 状态 | 说明 |
|-----|------|------|
| Cloudflare Workers 账户 | ✅ 已配置 | 有 API Token |
| Worker-1 部署完成 | ✅ 已完成 | URL: https://worker-1-interception.2238642875.workers.dev |
| BSC RPC 节点 | ✅ 可用 | 已在文档中记录 |
| 设计文档 | ✅ 已完成 | 安卓应用设计方案、数据存储设计 |
| Node.js 环境 | ✅ 已安装 | workspace 中有 node_modules |

### 8.2 需要补充的条件

| 条件 | 状态 | 说明 |
|-----|------|------|
| Android Studio | ❌ 未安装 | 需要在本地安装 |
| JDK | ❌ 未安装 | 需要在本地安装 |
| Android SDK | ❌ 未安装 | 随 Android Studio 安装 |
| Android 测试设备 | ❌ 未配置 | 需要真机或模拟器 |
| Cloudflare KV Namespace | ⚠️ 待确认 | 需要创建 KV 并绑定到 Worker |
| Worker-1 KV API | ❌ 未添加 | 需要扩展 Worker-1 |

### 8.3 结论

**当前 workspace 不满足完整的安卓开发环境**，因为：
1. 缺少 Android Studio 和 Android SDK（这些必须在本地安装）
2. 需要扩展 Worker-1 添加 KV API
3. 需要配置 Cloudflare KV Namespace

**但是 workspace 可以提供**:
- 后端 Worker 的部署和修改
- 设计文档和开发指南
- 项目代码版本管理

---

## 九、建议的启动步骤

### 第一阶段：环境准备（本地）
1. 安装 Android Studio 和 Android SDK
2. 安装 JDK
3. 配置测试设备（真机或模拟器）

### 第二阶段：后端扩展（workspace）
1. 创建 Cloudflare KV Namespace
2. 将 KV 绑定到 Worker-1
3. 扩展 Worker-1 添加 KV API (`/api/kv/put`, `/api/kv/get`, `/api/kv/delete`)
4. 修改 Worker-3、Worker-4 添加锁检查逻辑

### 第三阶段：项目初始化（本地）
1. 在本地创建 Android 项目
2. 配置 Gradle 依赖
3. 创建项目目录结构

### 第四阶段：核心开发（本地 + workspace）
1. 实现 Room 数据库
2. 实现 Web3 区块链交互
3. 实现分布式锁管理
4. 实现 UI 界面

### 第五阶段：测试和优化
1. 真机测试
2. 与云端 Workers 协作测试
3. 安全审计
4. 打包 APK

---

## 十、注意事项

### 10.1 关于测试钱包
**测试钱包不是必须的**，因为：
- APP 会在运行时由用户导入钱包
- 开发阶段可以使用测试钱包验证功能
- 生产环境用户自己管理钱包

### 10.2 关于手机号鉴权
- **Android 10-**: 可以自动读取本机号
- **Android 10+**: 无法自动读取，需要用户手动输入
- **开发阶段**: 将开发者手机号配置为 `bindPhoneNumber` 进行测试

### 10.3 关于网络环境
- 开发阶段可以使用免费的 BSC RPC 节点
- 生产环境建议使用付费 RPC 节点以确保稳定性
- Cloudflare KV API 必须保证网络连通性

### 10.4 关于安全性
- 私钥必须使用 Android Keystore 加密存储
- 不要在代码中硬编码密钥
- 生产环境必须使用正式签名打包

---

**最后更新**: 2026-01-23
