# 错误 #008 - 应急状态过早退出导致资产被盗

**日期**: 2026-01-22
**组件**: Worker-1 / Worker-3 / Worker-4
**版本**: v2.0.1

---

## 错误信息

```
[生产环境报错] 应急状态过早退出
时间: 2026-01-22 02:30
事件: 盗币者盗窃走约32个wkeyDAO
触发情况: 只触发了一次转移了0.002个BNB，由于gas费不足没能转移wkeyDAO
结果: 盗币者第二次转入0.001BNB，成功转移DAO，没能触发策略
```

---

## 影响范围

- [x] 功能异常
- [x] 资产损失
- [ ] 性能下降
- [ ] 用户体验影响

---

## 失败分析

1. **原因1**: V2版本应急状态机制未完整实现
   - Worker-3/4 发现转账后只写入 KV 标记（`emergency_state`）
   - Worker-1 的 scheduled 任务没有读取 KV 标记
   - Worker-1 没有调用 EmergencyExtension 执行应急循环
   - 结果：没有应急状态，只是简单扫描+转账，转完就结束

2. **原因2**: 应急状态设计有缺陷
   - EmergencyExtension.runEmergencyLoop() 在检测到 wkeyDAO>0 后立即退出
   - 退出后就没有持续监控
   - 给盗币者第二次转账的机会
   - 应急状态时长只有10分钟（太短）

3. **原因3**: 分布式锁可能导致状态抢占
   - 使用了 DistributedLock 扩展
   - 但 Worker-1 没有实际使用应急状态
   - 分布式锁配置存在但没有被调用

---

## 改进措施

**版本**: v2.0.2

### 改进1：Worker-1 增加应急状态读取和循环

**说明**: Worker-1 的 scheduled 任务现在检查 KV 应急状态标记，发现后进入应急循环

```javascript
// 检查是否有应急状态（由Worker-3/4触发）
const emergencyState = await checkEmergencyState(env)

if (emergencyState && emergencyState.triggered) {
  console.log('🚨 [Worker-1] 检测到应急状态，进入应急循环')

  // 进入应急状态循环
  await emergency.enterEmergencyMode()

  // 执行应急循环（不退出，持续监控）
  const result = await emergency.runEmergencyLoop({
    onScan: async (scanResults) => {
      console.log('📊 [应急扫描] 扫描结果:', scanResults.length, '个钱包')
    },
    onTransfer: async (triggerData) => {
      // 检测到wkeyDAO>0时触发转账
      console.log('💰 [应急扫描] 触发转账:', triggerData)
      await this._executeTransfer(triggerData.wallet, transferManager, db, triggerData.reason)
    }
  })

  return
}
```

### 改进2：EmergencyExtension 转账后不退出，直到 wkeyDAO=0

**说明**: 修改应急循环的退出条件，从"转账完成后退出"改为"所有钱包wkeyDAO余额为0才退出"

**问题分析**：
- V1.10版本失败原因：盗币者先转入0.002BNB，我们抢先转账成功，此时退出应急状态
- 然后盗币者第二次转入0.001BNB，此时常规扫描在1分钟空窗期
- 没能检测到wkeyDAO余额>0（实际是32枚），盗币者转移wkeyDAO成功

**修改前**：
```javascript
if (foundWallet) {
  // ... 触发转账 ...

  // 不退出应急状态，继续监控！
  console.log(`🔄 [${this.workerId}] 继续监控，等待下一次扫描...`)
  // 继续循环，不返回
}
// 没有明确的退出条件，只能等待超时
```

**修改后**：
```javascript
if (foundWallet) {
  // ... 触发转账 ...

  // 不退出应急状态，继续监控！
  console.log(`🔄 [${this.workerId}] 转账已触发，继续监控...`)
  // 继续循环，不返回
}

// 检查所有钱包的 wkeyDAO 余额是否都为 0
// 只有所有钱包都没有 wkeyDAO 时才退出应急状态
if (allWkeyDaoZero) {
  console.log(`✅ [${this.workerId}] 所有钱包的 wkeyDAO 余额为 0，退出应急状态`)
  await this.exitEmergencyMode('all_wkeydao_zero')
  return { success: true, reason: 'all_wkeydao_zero' }
}
```

### 改进3：延长应急状态时长

**说明**: 将应急状态最大时长从 10 分钟延长到 15 分钟，给盗币者更多时间盗取

```toml
# wrangler.toml
EMERGENCY_MAX_DURATION = 900     # 15分钟（从600延长到900）
```

```javascript
// Worker-3/4 触发应急状态时
await env.EMERGENCY_STORE.put('emergency_state', JSON.stringify({
  triggered: true,
  triggerSource: 'worker-3-surveillance',
  // ...
}), {
  expirationTtl: 900 // 15分钟过期（从600延长到900）
})
```

### 改进4：确认 wkeyDAO 优先转移

**说明**: 验证 TransferManager 已实现 wkeyDAO 优先转移逻辑

**实现**（`cloudflare/extensions/transfer/Transfer.js` 第52-62行）：
```javascript
// 1. 先转账 wkeyDAO
try {
  const wkeyDaoTx = await this.transferERC20(wallet, this.wkeyDaoToken)
  if (wkeyDaoTx) {
    results.wkeyDao = { success: true, hash: wkeyDaoTx.hash, amount: wkeyDaoTx.amount }
    console.log(`✅ wkeyDAO 转账成功: ${wkeyDaoTx.hash}`)
  }
} catch (error) {
  console.warn(`⚠️ wkeyDAO 转账失败:`, error.message)
  results.wkeyDao = { success: false, error: error.message }
}

// 2. 转账 BNB（扣除Gas费）
try {
  const bnbTx = await this.transferBNB(wallet)
  results.bnb = { success: true, hash: bnbTx.hash, amount: bnbTx.amount }
  console.log(`✅ BNB 转账成功: ${bnbTx.hash}, 金额: ${bnbTx.amount} BNB`)
} catch (error) {
  if (error.message.includes('余额不足支付Gas费') || error.message === '余额不足支付Gas费') {
    console.log(`⚠️ BNB 余额不足，跳过转账`)
    results.bnb = { success: false, error: error.message }
  } else {
    throw error
  }
}
```

**确认**：wkeyDAO 优先转移逻辑已正确实现 ✅

### 改进4：添加 account_id 到 Worker-3/4

**说明**: 确保 Worker-3/4 使用正确的 Cloudflare 帐号

```toml
# wrangler.toml
account_id = "7d8c0fb0cc70cda866c1f942a543417c"
```

---

## 改进验证

| 测试场景 | 输入 | 预期结果 | 实际结果 |
|----------|------|----------|----------|
| Worker-3 触发应急状态 | 发现盗币者转账 | 写入 KV 标记，TTL=900 | ⏳ 待测试 |
| Worker-4 触发应急状态 | 发现涡轮合约转账 | 写入 KV 标记，TTL=900 | ⏳ 待测试 |
| Worker-1 读取应急状态 | KV 有标记 | 进入应急循环 | ⏳ 待测试 |
| 应急循环执行（第一次） | wkeyDAO>0 | 触发转账，**不退出** | ⏳ 待测试 |
| 应急循环持续监控 | 盗币者第二次转入BNB | 再次触发转账，**继续监控** | ⏳ 待测试 |
| wkeyDAO 转移完成 | 所有钱包wkeyDAO=0 | **立即退出应急状态** | ⏳ 待测试 |
| 应急状态超时 | 15分钟后 | 退出应急状态 | ⏳ 待测试 |
| BNB 余额不足 | 只有BNB，没有wkeyDAO | 转账wkeyDAO失败，BNB转账或跳过 | ⏳ 待测试 |

---

## 相关文件

- `cloudflare/worker-1-interception/src/index.js` - Worker-1 主处理逻辑
- `cloudflare/extensions/emergency/EmergencyExtension.js` - 应急状态扩展
- `cloudflare/worker-3-surveillance/src/index.js` - Worker-3 监控告警
- `cloudflare/worker-4-turbine/src/index.js` - Worker-4 涡轮监控
- `cloudflare/worker-1-interception/wrangler.toml` - Worker-1 配置
- `cloudflare/worker-3-surveillance/wrangler.toml` - Worker-3 配置
- `cloudflare/worker-4-turbine/wrangler.toml` - Worker-4 配置

---

## 经验总结

1. **应急状态退出条件必须正确**:
   - **错误**：转账完成后就退出（给盗币者第二次转账的机会）
   - **正确**：所有钱包的 wkeyDAO=0 才退出（盗币者盗不走 wkeyDAO）
   - BNB 余额大概率不会为 0（有 Gas 费），不应作为退出条件

2. **应急循环必须持续监控**:
   - 检测到 wkeyDAO>0 后转账，但**不退出**，继续监控
   - 即使转账成功也要继续扫描，因为盗币者可能多次转入
   - 只有确认 wkeyDAO=0 才能退出

3. **wkeyDAO 必须优先转移**:
   - 先转 wkeyDAO，后转 BNB
   - 即使 BNB 余额不足支付 Gas，也要优先尝试转 wkeyDAO
   - 确保盗币者无法盗走 wkeyDAO 代币

4. **应急状态时长需要充足**:
   - 10分钟可能不够，延长到15分钟
   - 根据实际情况调整，宁可长不可短
   - 与盗币者的操作速度博弈

5. **部署前需要充分测试**:
   - 不能只看代码逻辑，需要实际运行测试
   - 模拟盗币者的多次转账行为
   - 确认应急循环不会过早退出

6. **常规扫描的空窗期问题**:
   - V1.10 版本：常规扫描每分钟一次，有空窗期
   - 应急状态：5秒扫描一次，无空窗期
   - 必须尽快进入应急状态，缩短空窗期

---

**最后更新**: 2026-01-22
