# Guard Plus 服务器部署指南

## 部署架构

```
前端 1: 您的服务器 (182.254.180.26) - 内网测试
前端 2: Pinme - 对外公开
后端: Cloudflare Worker
数据库: 新的 Supabase 数据库
```

---

## 第一步：准备 Supabase 数据库

### 1.1 创建新项目

登录 Supabase，创建一个新项目，专门用于 Guard Plus。

### 1.2 创建表

在 Supabase SQL Editor 中执行：

```sql
-- 扫描任务表
CREATE TABLE guard_tasks (
  id BIGSERIAL PRIMARY KEY,
  wallet_address VARCHAR(42) NOT NULL,
  vortex_start_time TIMESTAMP WITH TIME ZONE NOT NULL,
  scheduled_scan_time TIMESTAMP WITH TIME ZONE NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  high_freq_until TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE,

  CONSTRAINT valid_wallet CHECK (wallet_address IN (
    '0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89',
    '0x3D3914960567b3A253C429d5Ab81DA1F386F9111',
    '0x9F4fb2E9F0bb920EFceE6ca21ebf1B6A2f8D8e16'
  ))
);

-- 索引
CREATE INDEX idx_guard_tasks_status ON guard_tasks(status);
CREATE INDEX idx_guard_tasks_wallet ON guard_tasks(wallet_address);
CREATE INDEX idx_guard_tasks_scheduled ON guard_tasks(scheduled_scan_time);

-- 交易记录表
CREATE TABLE IF NOT EXISTS transactions (
  id BIGSERIAL PRIMARY KEY,
  wallet_address VARCHAR(42),
  type VARCHAR(20),
  action VARCHAR(50),
  token_address VARCHAR(42),
  amount TEXT,
  status VARCHAR(20),
  tx_hash TEXT,
  triggered_by VARCHAR(100),
  trigger_reason TEXT,
  error_message TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 错误日志表
CREATE TABLE IF NOT EXISTS error_logs (
  id BIGSERIAL PRIMARY KEY,
  error TEXT,
  context TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 1.3 获取连接信息

记录以下信息：
- Project URL: `https://xxx.supabase.co`
- anon/public Key: `eyJ...`

---

## 第二步：部署 Cloudflare Worker

### 2.1 安装依赖

```bash
cd /workspace/guard-plus/guard-plus-worker
npm install
```

### 2.2 配置 wrangler.toml

```toml
name = "guard-plus-worker"
account_id = "your-account-id"  # 替换为你的 Cloudflare Account ID
workers_dev = true

[vars]
BSC_RPC = "https://bsc-rpc.publicnode.com"
WKEYDAO_TOKEN = "0x194B302a4b0a79795Fb68E2ADf1B8c9eC5ff8d1F"
WATCHED_WALLETS = "0x886b739Ba73C1ccaE826Cb11c8d28e4750C68A89,0x3D3914960567b3A253C429d5Ab81DA1F386F9111,0x9F4fb2E9F0bb920EFceE6ca21ebf1B6A2f8D8e16"

# 安全配置
ALLOWED_IPS = "182.254.180.26"  # 你的服务器 IP
# ALLOWED_DOMAINS = ""  # 稍后部署到 Pinme 时添加

# Supabase 配置（替换为新数据库的信息）
SUPABASE_URL = "https://your-project.supabase.co"
SUPABASE_KEY = "your-anon-key"
```

### 2.3 设置 Secrets

```bash
# 设置安全钱包地址
npx wrangler secret put SAFE_WALLET
# 输入: 0x你的安全钱包地址

# 设置每个钱包的私钥（注意大小写）
npx wrangler secret put WALLET_PRIVATE_KEY_0x886b739ba73c1ccaE826cb11c8d28e4750c68a89
npx wrangler secret put WALLET_PRIVATE_KEY_0x3d3914960567b3a253c429d5ab81da1f386f9111
npx wrangler secret put WALLET_PRIVATE_KEY_0x9f4fb2e9f0bb920efceE6ca21ebf1b6a2f8d8e16
```

### 2.4 部署

```bash
npm run deploy
```

记下 Worker URL，例如：`https://guard-plus.3813518962.workers.dev`

---

## 第三步：部署到你的服务器 (182.254.180.26)

### 3.1 前端准备

```bash
cd /workspace/guard-plus/frontend
npm install
```

### 3.2 创建环境变量

创建 `.env.production` 文件：

```env
VITE_WORKER_URL=https://guard-plus.3813518962.workers.dev
```

### 3.3 构建前端

```bash
npm run build
```

构建产物在 `dist/` 目录。

### 3.4 上传到服务器

#### 方式 A：使用 scp 上传

```bash
# 打包
tar -czf guard-plus-frontend.tar.gz dist/

# 上传到服务器
scp guard-plus-frontend.tar.gz root@182.254.180.26:/tmp/

# SSH 登录服务器
ssh root@182.254.180.26
```

#### 方式 B：直接在服务器上操作

```bash
# 在本地打包后，复制 dist 目录内容到服务器
# 或者将整个 guard-plus 目录传到服务器，在服务器上构建
```

### 3.5 在服务器上部署（nginx 配置）

SSH 登录到服务器：

```bash
ssh root@182.254.180.26
```

#### 安装 nginx（如果没有）

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx -y

# CentOS
sudo yum install nginx -y
```

#### 部署前端文件

```bash
# 创建目录
sudo mkdir -p /var/www/guard-plus

# 解压并复制（如果用 scp 方式）
cd /tmp
tar -xzf guard-plus-frontend.tar.gz
sudo cp -r dist/* /var/www/guard-plus/
```

或者直接从本地复制 dist 目录内容：

```bash
# 在本地执行
scp -r /workspace/guard-plus/frontend/dist/* root@182.254.180.26:/var/www/guard-plus/
```

#### 配置 nginx

**使用 6060 端口**（避免与现有博客的 80 端口冲突）：

创建配置文件 `/etc/nginx/sites-available/guard-plus`：

```nginx
server {
    listen 6060;  # 使用 6060 端口（非常规端口）
    server_name _;  # 如果有域名，替换为实际域名

    root /var/www/guard-plus;
    index index.html;

    # 启用 gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Vue Router history 模式支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 代理（可选，如果需要）
    location /api/ {
        proxy_pass https://guard-plus.3813518962.workers.dev;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/guard-plus /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载 nginx
sudo systemctl reload nginx
```

#### 设置权限

```bash
sudo chown -R www-data:www-data /var/www/guard-plus
sudo chmod -R 755 /var/www/guard-plus
```

### 3.6 配置 HTTPS（可选但推荐）

#### 使用 Let's Encrypt

```bash
# 安装 certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取证书（需要先配置域名 DNS）
sudo certbot --nginx -d your-domain.com
```

#### 配置自动续期

```bash
sudo certbot renew --dry-run
```

### 3.7 验证部署

在浏览器访问：

- 使用 IP + 6060 端口：`http://182.254.180.26:6060`
- 如果有域名：`http://your-domain.com:6060`

应该能看到 Guard Plus 管理界面。

**开放防火墙端口**（如果需要）：

```bash
sudo ufw allow 6060/tcp
```

---

## 第四步：测试

### 4.1 测试 API 连接

打开浏览器控制台，输入：

```javascript
fetch('https://guard-plus.3813518962.workers.dev/health')
  .then(r => r.json())
  .then(console.log)
```

应该返回：
```json
{
  "status": "ok",
  "service": "guard-plus-worker",
  "timestamp": "..."
}
```

### 4.2 创建测试任务

1. 选择一个钱包地址
2. 输入一个未来的时间（如 10 分钟后）
3. 点击"创建任务"
4. 检查任务是否出现在任务列表中

### 4.3 测试监控

1. 等待到达扫描时间
2. 点击"监控"按钮
3. 观察余额监控是否正常工作

---

## 第五步：部署到 Pinme

### 5.1 获取 Pinme 域名

部署到 Pinme 后，记下你的域名，例如：
```
https://your-app.pinme.cn
```

### 5.2 更新 Worker 白名单

编辑 `guard-plus/guard-plus-worker/wrangler.toml`：

```toml
ALLOWED_IPS = "182.254.180.26"
ALLOWED_DOMAINS = "your-app.pinme.cn"
```

重新部署 Worker：

```bash
cd /workspace/guard-plus/guard-plus-worker
npm run deploy
```

### 5.3 构建前端

```bash
cd /workspace/guard-plus/frontend
```

创建 `.env.production`：

```env
VITE_WORKER_URL=https://guard-plus.3813518962.workers.dev
```

构建：

```bash
npm run build
```

### 5.4 部署到 Pinme

将 `dist/` 目录上传到 Pinme（具体操作参考 Pinme 文档）。

### 5.5 验证

访问 `https://your-app.pinme.cn`，测试是否正常工作。

---

## 常见问题

### 1. 403 Access denied

**原因**：IP 或域名不在白名单中

**解决**：
- 检查 `ALLOWED_IPS` 和 `ALLOWED_DOMAINS` 配置
- 查看浏览器控制台的错误信息
- 确认前端的 `VITE_WORKER_URL` 配置正确

### 2. CORS 错误

**原因**：跨域请求被阻止

**解决**：Worker 已配置 CORS，如果仍有问题，检查网络请求头

### 3. nginx 404 错误

**原因**：配置文件路径错误或未启用

**解决**：
```bash
# 检查配置
ls -la /etc/nginx/sites-enabled/

# 确认软链接存在
sudo nginx -t

# 重载配置
sudo systemctl reload nginx
```

### 4. 静态资源 403

**原因**：文件权限问题

**解决**：
```bash
sudo chown -R www-data:www-data /var/www/guard-plus
sudo chmod -R 755 /var/www/guard-plus
```

---

## 安全建议

1. **限制 SSH 访问**：只允许你的 IP 访问服务器
2. **配置防火墙**：
   ```bash
   sudo ufw allow 6060/tcp  # Guard Plus 端口
   sudo ufw allow 80/tcp     # 博客端口
   sudo ufw allow 443/tcp
   sudo ufw allow 22/tcp
   sudo ufw enable
   ```
3. **定期更新**：
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```
4. **备份数据库**：定期备份 Supabase 数据

---

## 更新流程

### 更新前端

```bash
cd /workspace/guard-plus/frontend
npm run build
# 重新上传 dist/ 目录到服务器
scp -r dist/* root@182.254.180.26:/var/www/guard-plus/
```

### 更新 Worker

```bash
cd /workspace/guard-plus/guard-plus-worker
npm run deploy
```
