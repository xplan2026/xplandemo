# 数据库设计探讨

## 项目目标描述

### 本项目中的定义

1. **项目目标：反盗币系统设计**

2. **项目概述**
    **项目名称**：X-plan
    **项目描述**：被保护钱包钱私钥被盗，盗币者可以转移被保护钱包的资产；本项目通过多个worker实现钱包监控、抢跑、定时任务、记录交易/查询等功能来保护被保护钱包的资产。
    - 主页实现web3登录
    - worker前端实现白名单登录
    **作者**：Milaifon Alex
    **仓库**：
        - Github：https://github.com/yuleague/X-plan
        - CnbCool: https://cnb.cool/yuleague/bsc-guard-system
    **前端地址**：
        - 主页：https://x-plan.top
        - Pinme导航页：
        - worker-1-前端：
        - worker-2-前端：
        - worker-3-前端：
    **License**：MIT



3. **自定义概念**

首先我们重新定义几个概念，新概念用于之后的构建，之前文件修改时请询问：
以下定义的概念的变量命名请CodeBuddy自定义：
- *被保护钱包*：原定义为监控钱包
- *安全钱包*：原定义不变
- *盗币者钱包地址*：新增非隐私，地址为（0x4A01eFCdA6d077A8AF6555Aa83Bc11E7be093561,
0xF95B911a3d26b076a10aC726Fde5D800972104B4）
- *合约地址*：原定义为常用代币，新构建只保留`BNB`，`wkeyDAO`.

### 本项目可以参考利用的资源：

- `Cloudflare-worker`
- `Cloudflare-KV`
- `Supabase-Postgres`
- `Supabase-edge-function`
- 腾讯云服务器（182.254.180.26）
- 新启用域名：x-plan.top

2. 我准备创建三个`worker`，它们的功能不同，但目标一致：就是**反盗币**！
- 已知约束条件：
    - 转移资产需要足够的gas费，此链的Gas费由`BNB`支付，从已有的交易记录显示Gas费在0.0001-0.0005之间。
    - `wkeyDAO`特殊的**涡轮**设计
        - 在将`wkeyDAO`转移至安全钱包时之前，需要有一个**涡轮**过程，约12小时，是否进入**涡轮**过程及进入时间可观测。
        - **涡轮**过程结束后，`wkeyDAO`会自动发送到被保护钱包。
    - 盗币者盗币操作流程（我们观测这个过程约2分钟）：
        - 盗币者钱包地址发送`BNB`到被保护钱包地址（因为我们提前清空了被保护钱包中的`BNB`至不足以支付Gas费）
        - 等待**涡轮**过程结束，直到被保护钱包中有`wkeyDAO`
        - 从盗币者主动转入`BNB`到被保护钱包地址——到等待`wkeyDAO`自动转入（也有盗币者观察到被保护钱包中有`wkeyDAO`余额后再转入`BNB`），时间约低于1分钟
        - 从被保护钱包地址发送`wkeyDAO`到其它地址（不一定是现有发现的盗币者地址），这个过程约15秒，我们安全性设计把这个过程估算为10秒
    - `Cloudflare-worker`支持的任务执行频率为每分钟一次
    - `BSC-RPC`节点对单一地址访问频率的限制为每秒15次，本项目由于要监控5个地址，并且有应急任务时5秒扫描一次的情况，容易造成访问单一地址访问频率过高，所以设计了`RPC-pool`扩展

### 本项目工作流设计

- **worker-1-interception**:实现抢先转移，其实现功能等同于`cloudflare-worker`
    - 常规扫描：每分钟扫描一次钱包中BNB和`wkeyDAO`的余额，
    - 当被保护钱包地址有新增`BNB`，或BNB大于0.001时，立即执行应急任务
    - 应急状态（重要：应急状态的最大时长为10分钟）
        -1. 每5秒一次扫描本钱包中的`wkeyDAO`余额，
        -2. 只要`wkeyDAO`余额>0，立即转移`wkeyDAO`和`BNB`（扣除Gas费的余额）至安全钱包
        - 将交易记录保存到`Supabase-Postgres`中（成功或失败或空；判断规则与`worker-2-interception`内容相同）
        - 退出应急状态

- **worker-2-interception**:实现定时任务，其实现功能等同于`guard-plus-worker`
    - 由于我们可以观测到**涡轮**的开始时间并预测到结束时间，所以我们设计为提前30分钟开始扫描任务（即在**涡轮**结束前30分钟）
    - 在前端中增加表单，用户可以输入**涡轮**结束时间，并点击“创建任务”按钮，创建任务，以下是对整个任务的描述：
    - 扫描任务
        - 每分钟扫描一次钱包中`BNB`和`wkeyDAO`的余额
        - 任务结束条件：
            - 最长时间=**涡轮**结束时间+10分钟
            - 如果没有触发紧急状态：
                - 达到最长时间，结束任务
            - 如果执行了紧急状态：
                - 达到最长时间，结束任务
                - 执行转移操作
                    - 获得交易成功返回：结束任务
                    - 获得交易失败返回：
                        - 重新扫描代币余额
                        - 如果`wkeyDAO`余额>0，继续执行转移操作(包括`BNB`)
                        - 如果代币余额=0，结束任务
    - 应急状态（重要：应急状态的最大时长为10分钟）
        - 转为**应急状态**条件：
            1. 有新增`BNB`，
            2. 或`BNB`余额大于0.001
            3. 或`wkeyDAO`余额>0
        - 应急状态工作描述：
            - 5秒一次扫描本钱包中的`wkeyDAO`余额
            - 只要`wkeyDAO`余额>0，立即转移`wkeyDAO`和`BNB`（扣除Gas费的余额）至安全钱包
    
    - 可以前端查看任务列表、任务状态、任务记录
        - 任务状态：
            - 未开始：任务未开始，可以修改任务时间
            - 进行中：任务正在进行中，可以查看任务记录
            - 已完成：任务已完成，可以查看任务记录
        - 任务记录（保存到`Supabase-Postgres`中）：
            - 成功转移交易记录：时间、各代币金额
            - 失败转移交易记录：时间、标记失败
                - 失败的判断逻辑：
                    - 发现了`wkeyDAO`增加，开始执行转移操作，
                    - 但转移失败
                        - 系统提示的`wkeyDAO`交易失败返回码
                        - 系统提示的`BNB`交易失败返回码
            - 无交易记录：在任务结束时没有发现`wkeyDAO`增加，显示无相关交易记录
    
    - 只要`wkeyDAO`余额>0，立即转移`wkeyDAO`和`BNB`（扣除Gas费的余额）至安全钱包
    - 将交易记录保存到`Supabase-Postgres`中

- **worker-3-surveillance**:实现反监视并及时转移资产，功能暂未实现
    - **常规扫描**：每分钟扫描一次盗币者钱包是否有往被保护钱包转入`BNB`和`wkeyDAO`代币的交易记录，
    - **触发条件**：当发现近期（区分于上次扫描结果）有往被保护钱包转入`BNB`和`wkeyDAO`代币的交易记录时，立即转为应急状态操作：
    - **应急状态**（重要：应急状态的最大时长为10分钟）：
        - 5秒一次扫描刚才扫描结果中被转入代币的被保护钱包地址，
        - 如果被保护钱包地址中`wkeyDAO`余额>0，立即转移`wkeyDAO`和`BNB`（扣除Gas费的余额）至安全钱包
        - 将交易记录保存到`Supabase-Postgres`中（成功或失败或空；判断规则与`worker-2-interception`内容相同）
        - 退出应急状态
**备注**：在分支BSC-Guard-system-v1.0版本中，好像没有实现退出应急状态的功能！！！需立即修复（与当前cloudflare-worker中的代码相同，可查看）

## 我现在有一个问题没有思考好，描述如下：

### 数据库设计问题

1. 每个worker是否单独一个数据库？
    - 如果单独配置，每个的API配置都不同，难于管理
    - 如果共用一个数据库，数据库会变得庞大，非常容易超出免费额度，并影响性能
    - 如果共用一个数据库，如何设计？

2. 可否按功能区分部署多个数据库（暂时优选）
    - 专用于交易记录的数据库
        - 3个worker的交易记录原则上可以保存到同一个表，但需增加字段区分worker，在数据中台（数据中台参见本文`## 数据中台设计与实现`）中可以通过字段区分worker，并分析哪一处worker的成功率较低
    - 专用于前端白名单鉴权登录的数据库
    - 需要在环境变量中标记不同任务的数据库连接方式
    - 可否增加一个数据库操作的`Extension`
        - 3个worker执行的任务对象实际上很可能是同个，所以写入的时间非常接近，容易造成阻塞
        - 由于写入非紧急任务，是否可以在写入时增加一个延迟，以避免阻塞？3个worker的写入延迟时间可以不同，最大概率减少阻塞
        - 不同的任务连接不同的数据库（比如交易记录vs登录鉴权）
        - 3个worker都有各自的前端页面，但鉴权逻辑和白名单配置一样，所以鉴权登录也是一个单独的`Extension`
        - 为数据中台预留接口

## 数据中台设计与实现
(暂不讨论)