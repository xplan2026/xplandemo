# X-plan 2026 代码安全审计报告

**审计日期**: 2026-02-09
**审计范围**: 整个项目代码库
**审计类型**: 深度代码审计

---

## 执行摘要

本次审计发现了 **6个严重问题**、**5个高危问题**、**5个中危问题** 和 **5个低危问题**。

最关键的问题是 **硬编码的私钥和敏感 Token 泄露**，这些必须立即处理以防止资产损失。

---

## 🔴 严重问题 - 必须立即修复

### 1. 硬编码的私钥泄露

**位置**: `d:/TOBEHOST/xplan2026/.env` (第22, 26, 30行)

**问题描述**:
```bash
PROTECTED_PRIVATE_KEY=0x7014d336359259400ef8de1ccd9e7a1364f003d3767445f7f6f91a14327bfae6
SAFE_PRIVATE_KEY=0x0d6f2d42516fed4396ce318274e19f4293b276ba878cd6120e99ec52501fe21d
GAS_PRIVATE_KEY=0x9ce6502d68d2b6da3a9d1bcf97a84985e294fa3bd2711ac3d69fe82172a400cd
```

**风险等级**: 🔴 严重

**风险详情**:
- 三个钱包的私钥直接硬编码在 .env 文件中
- 如果此文件被提交到 Git 仓库，私钥将永久暴露
- 攻击者可以直接控制这些钱包，转移所有资产

**修复建议**:
```bash
# 1. 立即删除 .env 文件中的私钥值，改为占位符
PROTECTED_PRIVATE_KEY=<your-protected-wallet-private-key>
SAFE_PRIVATE_KEY=<your-safe-wallet-private-key>
GAS_PRIVATE_KEY=<your-gas-wallet-private-key>

# 2. 将私钥迁移到 Cloudflare Workers Secrets
npx wrangler secret put WALLET_PRIVATE_KEY_32af4057...
npx wrangler secret put SAFE_WALLET_PRIVATE_KEY
npx wrangler secret put GAS_FUNDING_WALLET_PRIVATE_KEY

# 3. 撤销并重新生成所有受影响的钱包地址和私钥
```

---

### 2. Cloudflare API Token 泄露

**位置**: `d:/TOBEHOST/xplan2026/.env` (第70行)

**问题描述**:
```bash
CLOUDFLARE_API_TOKEN=<your-cloudflare-api-token>
```

**风险等级**: 🔴 严重

**风险详情**:
- Cloudflare API Token 泄露可能导致攻击者完全接管 Cloudflare 账户
- 攻击者可以部署恶意代码到 Workers
- 可以修改 DNS 记录，劫持域名

**修复建议**:
```bash
# 1. 立即到 Cloudflare Dashboard 撤销 Token
# 访问: https://dash.cloudflare.com/profile/api-tokens
# 撤销现有的 API Token

# 2. 重新生成新的 API Token

# 3. 更新环境变量（不要硬编码到代码中）
CLOUDFLARE_API_TOKEN=<your-new-token>

# 4. 配置到 GitHub Secrets
# GitHub 仓库 → Settings → Secrets and variables → Actions
# 添加 CLOUDFLARE_API_TOKEN
```

---

### 3. GitHub Token 泄露

**位置**: `d:/TOBEHOST/xplan2026/.env` (第150行)

**问题描述**:
```bash
GITHUB_TOKEN=<your-github-token>
```

**风险等级**: 🔴 严重

**风险详情**:
- GitHub Token 泄露可能导致仓库被篡改
- 攻击者可以提交恶意代码
- 可以删除仓库和所有历史记录

**修复建议**:
```bash
# 1. 立即到 GitHub 设置中撤销 Token
# 访问: https://github.com/settings/tokens
# 撤销现有的 GitHub Token

# 2. 从 .env 中删除此配置

# 3. 使用 GitHub CLI 进行认证
gh auth login

# 或使用 SSH 密钥进行 Git 操作
```

---

### 4. SSH 登录命令泄露

**位置**: `d:/TOBEHOST/xplan2026/.env` (第156行)

**问题描述**:
```bash
TERMINAL_LOGIN_COMMAND=ssh -i ~/.ssh/xplan_server_key ubuntu@182.254.180.26
```

**风险等级**: 🔴 严重

**风险详情**:
- 服务器 IP 地址 (182.254.180.26) 暴露
- SSH 密钥路径泄露
- 攻击者可以针对该服务器进行定向攻击

**修复建议**:
```bash
# 1. 立即从 .env 文件中删除此配置

# 2. 将服务器信息移至私有文档或密码管理器

# 3. 启用防火墙，限制 SSH 访问来源 IP
sudo ufw allow from YOUR_IP_ADDRESS to any port 22
sudo ufw enable

# 4. 配置 SSH 使用密钥而非密码
# 编辑 /etc/ssh/sshd_config
PasswordAuthentication no
PubkeyAuthentication yes
```

---

### 5. 前端暴露私钥变量

**位置**: `d:/TOBEHOST/xplan2026/frontend/official-site/src/lib/config.ts` (第29行)

**问题描述**:
```typescript
protectedPrivateKey: import.meta.env.VITE_PROTECTED_PRIVATE_KEY || '',
```

**风险等级**: 🔴 严重

**风险详情**:
- VITE_ 前缀的环境变量会被打包进前端代码
- `VITE_PROTECTED_PRIVATE_KEY` 如果有值，将在浏览器中可见
- `frontend/official-site/.env` (第36行) 中确实设置了私钥值

**修复建议**:
```typescript
// 1. 立即删除 frontend/official-site/.env 中的私钥配置
// 2. 从 config.ts 中移除 protectedPrivateKey 字段
// 3. 私钥操作应只在后端/Worker 中执行

// 正确的配置应该是:
export const config = {
  protectedAddress: import.meta.env.VITE_PROTECTED_ADDRESS || '',
  // protectedPrivateKey 不应存在于前端
}
```

---

### 6. 数据库 RLS 策略过于宽松

**位置**: `d:/TOBEHOST/xplan2026/supabase/worker/create-worker-database.sql`

**问题描述**:
```sql
CREATE POLICY "Allow public read on whitelist"
  ON auth_schema.whitelist FOR SELECT TO public USING (true);
CREATE POLICY "Allow public read on auth_nonce"
  ON auth_schema.auth_nonce FOR SELECT TO public USING (true);
```

**风险等级**: 🔴 严重

**风险详情**:
- `auth_nonce` 表包含临时的认证 nonce，不应公开读取
- `whitelist` 表可能包含敏感的白名单信息
- `USING (true)` 意味着任何人都可以读取

**修复建议**:
```sql
-- 删除过宽松的策略
DROP POLICY "Allow public read on auth_nonce" ON auth_schema.auth_nonce;

-- 创建更严格的策略
CREATE POLICY "Allow service read on auth_nonce"
  ON auth_schema.auth_nonce FOR SELECT
  TO authenticated
  USING (wallet_address = auth.uid());

-- 或者在应用层处理 nonce，不存储到数据库
```

---

## 🟠 高危问题 - 应尽快修复

### 7. GitHub Actions 中使用 StrictHostKeyChecking=no

**位置**: `.github/workflows/deploy-frontend.yml` (已修复)

**风险等级**: 🟠 高

**风险详情**:
- `StrictHostKeyChecking=no` 会跳过主机密钥验证
- 容易遭受中间人攻击

**修复建议**:
```yaml
# 移除 -o StrictHostKeyChecking=no
rsync -avz --delete \
  -e "ssh" \
  ./frontend/official-site/dist/ \
  user@host:/path/
```

---

### 8. Worker API 认证仅依赖 Header

**位置**: `cloudflare/tactics-1/src/index.js` (第487-496行)

**风险等级**: 🟠 高

**风险详情**:
- 仅依赖单一的 Header 认证
- API Key 可能被日志记录或抓包捕获
- 没有请求签名验证
- 没有时间戳验证，可能遭受重放攻击

**修复建议**:
```javascript
// 实现请求签名验证
async function verifyRequestSignature(request, env) {
  const timestamp = request.headers.get('X-Timestamp')
  const signature = request.headers.get('X-Signature')
  const apiKey = request.headers.get('X-API-Key')

  // 验证时间戳（防止重放攻击）
  const now = Date.now()
  if (!timestamp || Math.abs(now - parseInt(timestamp)) > 300000) {
    return false
  }

  // 验证签名
  const body = await request.text()
  const expectedSignature = crypto.subtle.sign(
    'HMAC',
    env.API_SECRET_KEY,
    `${timestamp}:${body}`
  )

  return signature === expectedSignature
}

// 添加请求频率限制
async function checkRateLimit(env, ip) {
  const key = `ratelimit:${ip}`
  const count = await env.RPC_POOL.get(key) || 0
  if (count > 60) return false
  await env.RPC_POOL.put(key, count + 1, { expirationTtl: 60 })
  return true
}
```

---

### 9. 前端使用 localStorage 存储敏感信息

**位置**: `frontend/DemoSite/js/sidebar.js` (第55-91行)

**风险等级**: 🟠 高

**风险详情**:
- localStorage 可被任何 JavaScript 代码访问
- XSS 攻击可以窃取钱包地址
- 没有加密存储

**修复建议**:
```javascript
// 1. 使用 sessionStorage 而非 localStorage（页面关闭后清除）
// 2. 添加数据加密
import CryptoJS from 'crypto-js';

const encrypt = (data, key) => {
  return CryptoJS.AES.encrypt(data, key).toString()
}

const decrypt = (ciphertext, key) => {
  const bytes = CryptoJS.AES.decrypt(ciphertext, key)
  return bytes.toString(CryptoJS.enc.Utf8)
}

// 3. 考虑使用 Web Crypto API
// 4. 或直接不在客户端存储，每次重新连接
```

---

### 10. CORS 配置允许所有来源

**位置**: `cloudflare/tactics-1/src/index.js` (第442-447行)

**风险等级**: 🟠 高

**风险详情**:
- 允许任何域名访问 API
- 可能导致 CSRF 攻击

**修复建议**:
```javascript
createCorsHeaders(request) {
  const origin = request.headers.get('Origin')
  const allowedOrigins = [
    'http://localhost:5173',
    'http://localhost:5174',
    'http://localhost:6060',
    'https://xplan-official.pinit.eth.limo'
  ]

  return {
    'Access-Control-Allow-Origin': allowedOrigins.includes(origin) ? origin : '',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, X-API-Key, X-Timestamp, X-Signature',
    'Access-Control-Allow-Credentials': 'true',
    'Access-Control-Max-Age': '86400'
  }
}
```

---

### 11. 缺少输入验证和参数清理

**位置**: `cloudflare/tactics-1/src/index.js` (第802-813行)

**风险等级**: 🟠 高

**风险详情**:
- 虽然有格式验证，但没有长度限制和边界检查
- 可能导致日志注入或路径遍历

**修复建议**:
```javascript
function validateWalletAddress(address) {
  // 1. 格式验证
  if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
    return false
  }

  // 2. 黑名单检查
  const blacklistedAddresses = [
    '0x0000000000000000000000000000000000000000',
    '0x0000000000000000000000000000000000000001'
  ]
  if (blacklistedAddresses.includes(address.toLowerCase())) {
    return false
  }

  // 3. 校验和验证（使用 ethers 库）
  try {
    return ethers.getAddress(address) === address
  } catch {
    return false
  }
}
```

---

## 🟡 中危问题 - 建议修复

### 12. 缺少安全 Headers

**位置**: `cloudflare/tactics-1/src/index.js`

**修复建议**:
```javascript
createCorsHeaders() {
  return {
    'Access-Control-Allow-Origin': this.getOrigin(request),
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, X-API-Key',
    'X-Content-Type-Options': 'nosniff',
    'X-Frame-Options': 'DENY',
    'X-XSS-Protection': '1; mode=block',
    'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
    'Content-Security-Policy': "default-src 'self'"
  }
}
```

### 13. 错误信息泄露

**位置**: `cloudflare/extensions/database/DatabaseExtension.js` (第237-246行)

**修复建议**:
```javascript
// 即使在开发环境，也不应返回完整错误堆栈
// 错误日志应发送到 Sentry 或日志服务，而非返回给客户端
```

### 14. 日志中包含敏感信息

**位置**: `cloudflare/tactics-1/src/index.js` (多处)

**修复建议**:
```javascript
// 生产环境禁用详细日志
if (env.NODE_ENV === 'production') {
  console.log(`🔍 [${WORKER_ID}] 钱包 ${walletAddress.slice(-4)} 扫描完成`)
} else {
  console.log(`🔍 [${WORKER_ID}] 钱包 ${walletAddress.slice(-4)} 扫描完成:`, {
    pol: scanResult.polBalance,
    xpd: scanResult.xpdBalance,
    action: scanResult.action
  })
}
```

### 15. 代码重复

**位置**: `frontend/official-site/src/pages/DemoPage.tsx` (第76-103行)

**修复建议**: 删除重复的函数定义

### 16. 缺少类型定义

**位置**: 多处前端代码

**修复建议**:
```typescript
// 为 API 响应添加类型定义
interface WalletStatus {
  wallet: string;
  wallet_short: string;
  pol_balance: number;
  xpd_balance: number;
  action: 'none' | 'transfer' | 'emergency';
}
```

---

## 🔵 低危问题 - 可以后续优化

### 17. 硬编码的配置值

**位置**: `cloudflare/tactics-1/src/index.js` (第31-42行)

**修复建议**: 将更多配置移至 wrangler.toml 或环境变量

### 18. 缺少速率限制实现

**位置**: `cloudflare/tactics-1/src/index.js`

**修复建议**:
```javascript
async function checkRateLimit(env, ip) {
  const key = `ratelimit:${ip}`
  const now = Date.now()

  const data = await env.RPC_POOL.get(key, { type: 'json' })
  if (data && data.count >= 60 && (now - data.timestamp) < 60000) {
    return false
  }

  await env.RPC_POOL.put(key, JSON.stringify({
    count: (data?.count || 0) + 1,
    timestamp: now
  }), { expirationTtl: 60 })

  return true
}
```

### 19. vite.config.ts 缺少安全配置

**位置**: `frontend/official-site/vite.config.ts`

**修复建议**:
```typescript
export default defineConfig({
  build: {
    sourcemap: process.env.NODE_ENV === 'development',
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: process.env.NODE_ENV === 'production',
      },
    },
  },
  server: {
    headers: {
      'X-Content-Type-Options': 'nosniff',
      'X-Frame-Options': 'DENY',
    },
  },
});
```

### 20. 依赖版本不一致

**位置**: `package.json` 文件

**修复建议**: 统一前后端的 ethers.js 版本

### 21. 缺少自动化测试

**修复建议**: 添加单元测试和集成测试

---

## 📊 依赖安全审计

### 前端依赖 (`frontend/official-site/package.json`)

| 依赖包 | 版本 | 风险等级 | 建议 |
|--------|------|----------|------|
| ethers | ^6.16.0 | 中 | 已是最新版本，无已知漏洞 |
| @supabase/supabase-js | ^2.76.1 | 低 | 定期检查更新 |
| react | ^18.0.0 | 低 | 考虑升级到 v19 |

### Cloudflare Workers 依赖 (`cloudflare/package.json`)

| 依赖包 | 版本 | 风险等级 | 建议 |
|--------|------|----------|------|
| ethers | ^6.13.0 | 中 | 与前端版本不一致，建议统一到 ^6.16.0 |
| wrangler | ^4.61.1 | 低 | 定期检查更新 |

---

## 📋 修复优先级和行动计划

### 立即执行（24小时内）

- [ ] 删除 `.env` 文件中的所有私钥
- [ ] 撤销并重新生成 Cloudflare API Token
- [ ] 撤销并重新生成 GitHub Token
- [ ] 撤销并重新生成所有受影响钱包的私钥
- [ ] 检查 Git 历史，清理已提交的敏感信息
- [ ] 从前端配置中移除 `VITE_PROTECTED_PRIVATE_KEY`
- [ ] 从 `.env` 中删除 `TERMINAL_LOGIN_COMMAND`

### 本周内执行

- [x] 修复 GitHub Actions 中的 `StrictHostKeyChecking=no`
- [ ] 更新数据库 RLS 策略，移除过宽松的权限
- [ ] 实现 Worker API 请求签名验证
- [ ] 添加 CORS 白名单验证
- [ ] 实现 Worker 速率限制

### 本月内执行

- [ ] 实现前端 localStorage 加密
- [ ] 添加输入验证和参数清理
- [ ] 实现生产环境日志脱敏
- [ ] 添加安全 Headers
- [ ] 删除前端代码中的重复代码

### 持续优化

- [ ] 定期运行 `npm audit` 检查依赖漏洞
- [ ] 添加自动化安全扫描到 CI/CD 流程
- [ ] 实施数据库备份策略
- [ ] 统一前后端的 ethers.js 版本
- [ ] 添加更多的 TypeScript 类型定义

---

## 🔍 其他建议

### 代码质量改进

1. **添加 ESLint 安全规则**:
```json
{
  "extends": [
    "eslint:recommended",
    "plugin:security/recommended"
  ]
}
```

2. **使用 Pre-commit 钩子**:
```bash
#!/bin/bash
# .git/hooks/pre-commit
npm run lint
npm run test
npx trufflehog --regex --entropy=False .
```

3. **实施 Code Review 流程**:
   - 所有 PR 必须经过至少一人 Review
   - 使用安全检查清单

### 监控和告警

1. **设置 Cloudflare Workers 日志告警**
2. **设置 Supabase 数据库性能监控**
3. **设置 GitHub Actions 构建失败告警**

### 文档改进

1. **创建安全最佳实践文档**
2. **记录所有密钥和 Token 的生成/撤销流程**
3. **编写应急响应计划**

---

## 总结

本次审计发现了 **21个安全问题**，其中：

- 🔴 严重: 6个
- 🟠 高危: 5个
- 🟡 中危: 5个
- 🔵 低危: 5个

最关键的问题是 **硬编码的私钥和敏感 Token 泄露**，这些必须立即处理以防止资产损失。

其他问题虽然风险较低，但也应在合理时间内修复以提高整体安全性。

**建议**:
1. 立即处理严重问题
2. 本周内完成高危问题修复
3. 制定持续安全改进计划
4. 定期进行安全审计（每季度至少一次）

---

**报告生成**: 2026-02-09
**下次审计**: 建议 2026-05-09
