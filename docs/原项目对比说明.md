# X-plan Demo 项目与原项目（x-plan）对比说明

## 📌 概述

本文档详细说明了当前 **X-plan Demo** 项目与原 **x-plan** 项目的核心区别，帮助理解两者在架构、功能、目标等方面的不同。

---

## 🎯 核心定位差异

### 原项目 (x-plan)
- **定位**：生产级资产保护系统
- **目标**：保护真实用户的钱包资产，防止私钥被盗后的资产损失
- **场景**：应对实际的盗币攻击

### 本项目 (X-plan Demo)
- **定位**：演示和展示系统
- **目标**：通过可交互的演示站点，展示资产保护机制的工作原理
- **场景**：模拟私钥被盗场景，供用户体验和学习

---

## 🌐 区块链网络差异

| 对比项 | 原项目 (x-plan) | 本项目 (X-plan Demo) |
|--------|-----------------|---------------------|
| **主网络** | BSC (Binance Smart Chain) | Polygon Amoy Testnet |
| **Chain ID** | 56 | 80002 |
| **环境类型** | 主网（真实资产） | 测试网（演示用） |
| **网络特性** | 主网确认慢，费用高 | 测试网速度快，免费水龙头 |

---

## 💰 资产代币差异

### 原项目
- **Gas 代币**: BNB (BSC 原生代币)
- **保护代币**:
  - wkeyDAO (自定义 ERC20 代币)
  - USDT (稳定币)
- **代币精度**:
  - wkeyDAO: 18
  - USDT: 6

### 本项目
- **Gas 代币**: POL (Polygon 原生代币)
- **保护代币**:
  - XPD (自定义 ERC20 代币，精度 9)
  - **已移除**: USDT（演示不需要稳定币）
- **代币精度**:
  - XPD: 9

---

## 👛 钱包架构差异

### 原项目：多钱包保护架构
```
被保护钱包（3个）:
  - Wallet_1 (私钥被盗)
  - Wallet_2 (私钥被盗)
  - Wallet_3 (私钥被盗)

保护系统:
  - Safe Wallet (安全钱包，转移目标)
  - Gas Funding Wallet (Gas费补充钱包)
  - 分布式锁系统（防止多Worker竞争）
```

**特点**：
- 同时保护多个钱包
- 需要分布式锁机制协调多个Worker实例
- 复杂的并发控制逻辑

### 本项目：单钱包演示架构
```
被保护钱包（1个）:
  - Wallet_A (私钥将在前端公示)

保护系统:
  - Safe Wallet (安全钱包，转移目标)
  - Gas Funding Wallet (Gas费补充钱包)
  - 简化分布式锁（保留但可优化）
```

**特点**：
- 仅演示单个钱包的保护
- 分布式锁可简化（单Worker实例）
- 逻辑简单清晰，便于演示

---

## 🔧 技术架构差异

### Worker 架构

| 对比项 | 原项目 (x-plan) | 本项目 (X-plan Demo) |
|--------|-----------------|---------------------|
| **Worker 实例** | 多实例部署（需分布式锁） | 单实例为主 |
| **调度机制** | Cron Triggers + 竞争锁 | Cron Triggers + 简化锁 |
| **扩展架构** | 扩展池架构 | 扩展池架构（相同） |
| **RPC 节点池** | 5个 BSC 节点 | 5个 Polygon Amoy 节点 |
| **数据存储** | Supabase + KV | Supabase + KV（相同） |

### 扩展模块对比

**相同部分**：
- ✅ `EmergencyWorkerExtension` - 应急状态扩展
- ✅ `TransferWorkerExtension` - 转账扩展
- ✅ `AideWorkerExtension` - 交易监控扩展
- ✅ `TacticsScanner` - 余额扫描器
- ✅ `DatabaseExtension` - 数据库扩展
- ✅ `RpcPoolOptimizedExtension` - RPC连接池

**不同部分**：
- ❌ 原项目的 `GasFunder` 模块支持 BNB，本项目已修改为 POL
- ❌ 原项目的 `Transfer.js` 包含 USDT 转账逻辑，本项目已移除
- ❌ 原项目的分布式锁逻辑复杂，本项目已简化

---

## 🔄 执行逻辑差异

### 原项目执行流程
```
1. 定时任务触发（1分钟）
2. 获取分布式锁（多实例竞争）
3. 扫描3个被保护钱包
4. 判断是否需要转移资产
5. 触发应急状态（5秒扫描）
6. 转移 wkeyDAO + USDT
7. 补充 BNB Gas费
8. Aide 监控交易状态
9. 释放分布式锁
```

### 本项目执行流程
```
1. 定时任务触发（1分钟）
2. 简化锁检查（单实例）
3. 扫描1个被保护钱包
4. 判断是否需要转移资产
5. 触发应急状态（5秒扫描）
6. 转移 XPD（仅单一代币）
7. 补充 POL Gas费
8. Aide 监控交易状态
9. 退出应急状态
```

---

## ⚙️ 配置参数差异

### 原项目配置
```javascript
{
  PROTECTED_WALLETS: ['0x...', '0x...', '0x...'], // 3个钱包
  BSC_RPC: 'https://bsc-dataseed.binance.org/',
  TOKEN_WKEYDAO: '0x...',
  TOKEN_USDT: '0x...',
  BNB_THRESHOLD: 0.01,
  USDT_DECIMALS: 6,
  WALLET_SCAN_INTERVAL: 200, // 200ms间隔（多钱包需要）
}
```

### 本项目配置
```javascript
{
  PROTECTED_WALLETS: ['0x...'], // 1个钱包
  POLYGON_AMOY_RPC: 'https://rpc-amoy.polygon.technology',
  TOKEN_XPD: '0x35774A4E1fFEee74Fa3859F89cfae00b3aC8C3A8',
  POL_THRESHOLD: 0.0002,
  XPD_DECIMALS: 9,
  WALLET_SCAN_INTERVAL: 0, // 不需要间隔
}
```

---

## 🚀 关键代码修改点

### 1. TacticsScanner.js
```javascript
// 原项目
this.wkeyDaoToken = env.TOKEN_WKEYDAO
this.usdtToken = env.TOKEN_USDT
this.bnbThreshold = parseFloat(env.BNB_THRESHOLD || '0.01')

// 本项目
this.xpdToken = env.TOKEN_XPD || '0x35774A4E...'
this.xpdDecimals = parseInt(env.TOKEN_XPD_DECIMALS || '9')
this.polThreshold = parseFloat(env.POL_THRESHOLD || '0.0002')
```

### 2. Transfer.js
```javascript
// 原项目
async emergencyTransfer(walletAddress) {
  // 转移 wkeyDAO
  transfers.push(this.transferERC20(wallet, this.wkeyDaoToken, wkeyBalance))
  // 转移 USDT
  transfers.push(this.transferERC20(wallet, this.usdtToken, usdtBalance))
  // 转移 BNB
  transfers.push(this.transferBNB(wallet, bnbBalance))
}

// 本项目
async emergencyTransfer(walletAddress) {
  // 仅转移 XPD
  if (xpdBalance > 0n) {
    transfers.push(this.transferERC20(wallet, this.xpdToken, xpdBalance))
  }
  // POL 用于 Gas费，不主动转账（除非余额过高）
  if (polBalance > 200000000000000n) {
    transfers.push(this.transferPOL(wallet, polBalance))
  }
}
```

### 3. createDistributedLock（简化版）
```javascript
// 原项目：复杂的分布式锁实现
// - 支持多实例竞争
// - 心跳检测机制
// - 自动续期

// 本项目：简化的KV锁
// - 单实例使用
// - 简单的 TTL 机制
// - 无心跳检测
function createDistributedLock(env, db) {
  const LOCK_PREFIX = 'lock:'
  const DEFAULT_TTL = 600 // 10分钟

  return {
    async acquireLock(key, ttl = DEFAULT_TTL) {
      // 简化的KV锁实现
      await env.RPC_POOL.put(LOCK_PREFIX + key, lockValue, {
        expirationTtl: ttl
      })
    },
    async releaseLock(key) {
      await env.RPC_POOL.delete(LOCK_PREFIX + key)
    }
  }
}
```

---

## 📱 前端交互差异

### 原项目（无前端或简单API）
- 主要通过 Cloudflare Worker API 调用
- 无用户界面展示
- 后台静默运行

### 本项目（DemoSite）
- 完整的 Web 演示站点
- 实时显示钱包余额和状态
- 手动触发攻击模拟
- 应急状态切换控制
- 交易历史和日志展示

---

## 🔐 安全考虑差异

### 原项目
- ✅ 私钥必须使用 Cloudflare Secrets 加密存储
- ✅ 多实例部署需要严格的分布式锁
- ✅ 主网环境，任何错误都可能导致资产损失
- ✅ 需要完整的监控和告警系统

### 本项目
- ✅ 私钥使用 Cloudflare Secrets 存储（相同）
- ✅ 测试网环境，损失可接受
- ✅ 前端公钥/私钥展示（仅演示用途）
- ✅ 无需复杂监控和告警

---

## 📊 性能差异

| 对比项 | 原项目 (x-plan) | 本项目 (X-plan Demo) |
|--------|-----------------|---------------------|
| **扫描间隔** | 60秒 / 5秒 | 60秒 / 5秒（相同） |
| **钱包数量** | 3个 | 1个 |
| **代币数量** | 2个（wkeyDAO + USDT） | 1个（XPD） |
| **单次扫描耗时** | 约 15-20秒（多钱包） | 约 3-5秒（单钱包） |
| **并发控制** | 复杂（分布式锁） | 简化 |
| **Gas费消耗** | 高（主网） | 低（测试网） |

---

## 🎓 适用场景

### 原项目适用于
- ✅ 真实用户的资产保护需求
- ✅ 大规模部署到主网
- ✅ 多钱包保护场景
- ✅ 对安全性和稳定性有极高要求

### 本项目适用于
- ✅ 技术演示和教学
- ✅ 向用户展示资产保护原理
- ✅ 测试和开发验证
- ✅ PoC（概念验证）项目

---

## 📝 代码兼容性

### 已清除的 BSC 相关内容
- ❌ `TOKEN_WKEYDAO` → 已移除
- ❌ `TOKEN_USDT` → 已移除
- ❌ `BSC_RPC` → 替换为 `POLYGON_AMOY_RPC`
- ❌ `BNB_THRESHOLD` → 替换为 `POL_THRESHOLD`
- ❌ `bnbBalance` → 替换为 `polBalance`
- ❌ `transferBNB()` → 替换为 `transferPOL()`
- ❌ `transferUSDT()` → 已移除

### 保留的通用逻辑
- ✅ 扩展池架构
- ✅ RPC 节点池
- ✅ 数据库操作（Supabase）
- ✅ 交易重试机制
- ✅ Gas 费补充逻辑
- ✅ Aide 监控逻辑

---

## 🔧 后续优化建议

### 本项目可以进一步简化的部分
1. **分布式锁**：单实例场景下可以完全移除分布式锁
2. **RPC 节点池**：可以减少到 2-3 个节点
3. **数据库**：部分日志记录可以简化或移除
4. **Gas 补充**：测试网可以使用水龙头，无需自动补充

### 需要保留的核心逻辑
1. **应急状态切换**：这是核心演示功能
2. **抢先转移**：展示 Worker 的响应速度
3. **交易监控**：展示交易确认过程
4. **前端交互**：让用户直观体验保护机制

---

## 📚 总结

| 维度 | 原项目 (x-plan) | 本项目 (X-plan Demo) |
|------|-----------------|---------------------|
| **定位** | 生产级系统 | 演示系统 |
| **网络** | BSC 主网 | Polygon Amoy 测试网 |
| **代币** | wkeyDAO + USDT + BNB | XPD + POL |
| **钱包** | 3个被保护钱包 | 1个被保护钱包 |
| **架构** | 复杂（分布式锁） | 简化 |
| **前端** | 无/简单 | 完整 DemoSite |
| **安全要求** | 极高 | 演示级别 |
| **成本** | 高（主网Gas费） | 低（测试网） |

---

**文档版本**: v1.0
**最后更新**: 2026-02-10
**作者**: X-plan Demo Team
